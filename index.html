<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366f1'><path d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f0f13;
            --bg-secondary: #1a1a23;
            --bg-card: #22222d;
            --bg-elevated: #2a2a38;
            --accent: #6366f1;
            --accent-light: #818cf8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --border: rgba(255,255,255,0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header-left .subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .last-updated {
            font-size: 12px;
            color: var(--text-muted);
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 6px;
        }

        /* NEW: Today's Scores Hero - 3 big cards */
        .scores-hero {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .score-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-elevated) 100%);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .score-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .score-card.sleep::before { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
        .score-card.readiness::before { background: linear-gradient(90deg, #6366f1, #818cf8); }
        .score-card.activity::before { background: linear-gradient(90deg, #10b981, #34d399); }

        .score-card-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .score-card-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .score-card.sleep .score-card-icon { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
        .score-card.readiness .score-card-icon { background: rgba(99, 102, 241, 0.15); color: #6366f1; }
        .score-card.activity .score-card-icon { background: rgba(16, 185, 129, 0.15); color: #10b981; }

        .score-card-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .score-card-value {
            font-size: 56px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 8px;
        }

        .score-card.sleep .score-card-value { color: #8b5cf6; }
        .score-card.readiness .score-card-value { color: #6366f1; }
        .score-card.activity .score-card-value { color: #10b981; }

        .score-card-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .score-card-status.excellent { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        .score-card-status.good { background: rgba(99, 102, 241, 0.15); color: #6366f1; }
        .score-card-status.fair { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
        .score-card-status.low { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

        .score-card-status::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .score-card-avg {
            font-size: 12px;
            color: var(--text-muted);
        }

        .score-card-secondary {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* NEW: Today's Insight Card */
        .insight-hero {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .insight-hero-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: rgba(99, 102, 241, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
            flex-shrink: 0;
        }

        .insight-hero-text {
            flex: 1;
        }

        .insight-hero-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .insight-hero-message {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .insight-hero-recommendation {
            font-size: 14px;
            color: var(--accent-light);
            margin-bottom: 6px;
            padding-left: 16px;
            border-left: 2px solid var(--accent);
        }

        .insight-hero-recommendation:empty {
            display: none;
        }

        .insight-hero-pattern {
            font-size: 13px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .insight-hero-pattern:empty {
            display: none;
        }

        .insight-refresh-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            margin-left: 8px;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.2s;
            vertical-align: middle;
        }

        .insight-refresh-btn:hover {
            opacity: 1;
            background: rgba(99, 102, 241, 0.2);
        }

        .insight-refresh-btn.loading svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* NEW: Ask AI Section */
        .ask-ai-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 24px;
        }

        .ask-ai-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .ask-ai-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
        }

        .ask-ai-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .ask-ai-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .ask-ai-input-row {
            display: flex;
            gap: 12px;
        }

        .ask-ai-input {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 14px;
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .ask-ai-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .ask-ai-input::placeholder {
            color: var(--text-muted);
        }

        .ask-ai-btn {
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ask-ai-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .ask-ai-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .ask-ai-btn.loading svg {
            animation: spin 1s linear infinite;
        }

        .ask-ai-response {
            margin-top: 16px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 1px solid rgba(99, 102, 241, 0.15);
            border-radius: 10px;
            display: none;
        }

        .ask-ai-response.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ask-ai-response-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ask-ai-response-text {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .ask-ai-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .ask-ai-suggestion {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 12px;
            color: var(--accent-light);
            cursor: pointer;
            transition: all 0.2s;
        }

        .ask-ai-suggestion:hover {
            background: rgba(99, 102, 241, 0.2);
            border-color: var(--accent);
        }

        /* NEW: Quick Stats Row */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .quick-stat {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .quick-stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .quick-stat-icon.hrv { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        .quick-stat-icon.deep { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
        .quick-stat-icon.rhr { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .quick-stat-icon.steps { background: rgba(99, 102, 241, 0.15); color: #6366f1; }

        .quick-stat-content {
            flex: 1;
            min-width: 0;
        }

        .quick-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .quick-stat-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* NEW: 7-Day Trend with Sparkline */
        .trend-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .trend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .trend-title {
            font-size: 14px;
            font-weight: 600;
        }

        .trend-toggle {
            display: flex;
            gap: 4px;
            background: var(--bg-elevated);
            padding: 4px;
            border-radius: 6px;
        }

        .trend-toggle-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .trend-toggle-btn.active {
            background: var(--accent);
            color: white;
        }

        .trend-chart {
            height: 100px;
        }

        /* NEW: Collapsible Alerts */
        .alerts-collapsible {
            margin-bottom: 24px;
        }

        .alerts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .alerts-header:hover {
            background: var(--bg-elevated);
        }

        .alerts-header.has-warnings {
            border-color: rgba(245, 158, 11, 0.3);
            background: rgba(245, 158, 11, 0.05);
        }

        .alerts-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alerts-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .alerts-badge.warning {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .alerts-badge.success {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .alerts-title {
            font-size: 14px;
            font-weight: 500;
        }

        .alerts-expand {
            color: var(--text-muted);
            transition: transform 0.2s;
        }

        .alerts-header.expanded .alerts-expand {
            transform: rotate(180deg);
        }

        .alerts-content {
            display: none;
            padding: 16px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 12px 12px;
            margin-top: -12px;
        }

        .alerts-content.visible {
            display: block;
        }

        /* NEW: Expandable Details Sections */
        .details-section {
            margin-bottom: 24px;
        }

        .details-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .details-header:hover {
            background: var(--bg-elevated);
        }

        .details-header.expanded {
            border-radius: 12px 12px 0 0;
        }

        .details-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .details-icon.sleep { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
        .details-icon.activity { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        .details-icon.nutrition { background: rgba(6, 182, 212, 0.15); color: #06b6d4; }

        .details-title {
            flex: 1;
            font-size: 14px;
            font-weight: 600;
        }

        .details-expand {
            color: var(--text-muted);
            transition: transform 0.2s;
        }

        .details-header.expanded .details-expand {
            transform: rotate(180deg);
        }

        .details-content {
            display: none;
            padding: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 12px 12px;
        }

        .details-content.visible {
            display: block;
        }

        @media (max-width: 1024px) {
            .scores-hero {
                grid-template-columns: 1fr;
            }
            .quick-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .quick-stats {
                grid-template-columns: 1fr;
            }
            .score-card-value {
                font-size: 44px;
            }
            .ask-ai-input-row {
                flex-direction: column;
            }
            .ask-ai-btn {
                justify-content: center;
            }
            .ask-ai-suggestions {
                justify-content: center;
            }
            .ask-ai-section {
                padding: 16px;
            }
        }

        /* Legacy: Score Hero (kept for compatibility) */
        .score-hero {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .fitness-score {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-elevated) 100%);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .score-ring {
            width: 140px;
            height: 140px;
            margin: 0 auto 16px;
            position: relative;
        }

        .score-ring svg {
            transform: rotate(-90deg);
        }

        .score-ring .bg {
            fill: none;
            stroke: var(--bg-elevated);
            stroke-width: 12;
        }

        .score-ring .progress {
            fill: none;
            stroke: url(#scoreGradient);
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .score-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            font-weight: 700;
        }

        .score-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .score-breakdown {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .breakdown-item {
            text-align: center;
        }

        .breakdown-value {
            font-size: 18px;
            font-weight: 600;
        }

        .breakdown-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Key Metrics */
        .key-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-bottom: 12px;
        }

        .metric-icon.steps { background: rgba(99, 102, 241, 0.15); }
        .metric-icon.heart { background: rgba(239, 68, 68, 0.15); }
        .metric-icon.active { background: rgba(16, 185, 129, 0.15); }
        .metric-icon.workout { background: rgba(245, 158, 11, 0.15); }

        .metric-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .metric-change {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .metric-change.positive {
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .metric-change.negative {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        /* Nutrition Section */
        .nutrition-section {
            margin: 32px 0;
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .nutrition-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .nutrition-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .nutrition-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nutrition-icon.water { background: rgba(6, 182, 212, 0.15); color: #06b6d4; }
        .nutrition-icon.protein { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .nutrition-icon.quality { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        .nutrition-icon.meal { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }

        .nutrition-card-title {
            font-size: 14px;
            font-weight: 600;
            flex: 1;
        }

        .nutrition-percentage {
            font-size: 14px;
            font-weight: 600;
            color: #06b6d4;
        }

        /* Water Tracker */
        .water-progress-container {
            display: flex;
            align-items: baseline;
            gap: 6px;
            margin-bottom: 8px;
        }

        .water-count {
            font-size: 32px;
            font-weight: 700;
            color: #06b6d4;
        }

        .water-goal {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .water-progress-bar {
            height: 8px;
            background: var(--bg-elevated);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .water-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #06b6d4, #22d3ee);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .water-remaining {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .water-buttons {
            display: flex;
            gap: 8px;
        }

        .water-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .water-btn:hover {
            background: rgba(6, 182, 212, 0.15);
            border-color: #06b6d4;
        }

        .water-btn.minus:hover {
            background: rgba(239, 68, 68, 0.15);
            border-color: #ef4444;
        }

        /* Protein Tracker */
        .protein-estimate {
            font-size: 13px;
            color: var(--text-muted);
        }

        .protein-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .protein-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .protein-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-elevated);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .protein-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .protein-btn.active {
            background: rgba(239, 68, 68, 0.15);
            border-color: #ef4444;
        }

        .protein-level {
            font-weight: 600;
            font-size: 14px;
        }

        .protein-range {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Food Quality */
        .quality-score {
            font-size: 18px;
            font-weight: 700;
            color: #10b981;
        }

        .quality-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .quality-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .quality-btn {
            flex: 1;
            padding: 12px 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quality-btn:hover {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .quality-btn.active {
            background: rgba(16, 185, 129, 0.15);
            border-color: #10b981;
            color: #10b981;
        }

        .quality-description {
            font-size: 12px;
            color: var(--text-muted);
            text-align: center;
        }

        /* Meal Logger */
        .meal-count {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .meal-log-btn {
            width: 100%;
            padding: 14px;
            border: 2px dashed var(--border);
            border-radius: 10px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .meal-log-btn:hover {
            border-color: #8b5cf6;
            color: #8b5cf6;
            background: rgba(139, 92, 246, 0.05);
        }

        .meals-list {
            margin-top: 12px;
        }

        .meal-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg-elevated);
            border-radius: 8px;
            margin-top: 8px;
        }

        .meal-item-time {
            font-size: 12px;
            color: var(--text-muted);
            min-width: 50px;
        }

        .meal-item-desc {
            flex: 1;
            font-size: 13px;
        }

        .meal-item-protein {
            font-size: 12px;
            color: #ef4444;
            font-weight: 500;
        }

        @media (max-width: 1200px) {
            .nutrition-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .nutrition-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Trends Section */
        .trends-section {
            margin: 32px 0;
        }

        .time-range-selector {
            display: flex;
            gap: 4px;
            background: var(--bg-elevated);
            padding: 4px;
            border-radius: 8px;
        }

        .range-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .range-btn:hover {
            color: var(--text-primary);
        }

        .range-btn.active {
            background: var(--accent);
            color: white;
        }

        .comparison-grid {
            display: grid;
            gap: 16px;
        }

        .comparison-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .comparison-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .comparison-period {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .vs-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .comparison-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .comparison-item {
            text-align: center;
        }

        .comparison-label {
            display: block;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .comparison-values {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .current-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .comparison-delta {
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .comparison-delta.positive {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .comparison-delta.negative {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .comparison-delta.neutral {
            color: var(--text-muted);
            background: var(--bg-elevated);
        }

        .previous-value {
            font-size: 13px;
            color: var(--text-muted);
        }

        /* Records Section */
        .records-section {
            margin: 32px 0;
        }

        .records-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .record-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .record-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 12px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent);
        }

        .record-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .record-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .record-unit {
            font-size: 14px;
            font-weight: 400;
            color: var(--text-secondary);
        }

        .record-date {
            font-size: 11px;
            color: var(--text-muted);
        }

        .record-current {
            font-size: 11px;
            color: var(--accent);
            margin-top: 8px;
        }

        /* Milestones Section */
        .milestones-section {
            margin: 32px 0;
        }

        .btn-text {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-text:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-color: var(--accent);
        }

        .milestones-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .milestone-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .milestone-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .milestone-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .milestone-icon.steps { background: rgba(99, 102, 241, 0.15); color: var(--accent); }
        .milestone-icon.workouts { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
        .milestone-icon.streak { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

        .milestone-title {
            font-size: 14px;
            font-weight: 600;
        }

        .milestone-achieved {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .milestone-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .milestone-badge.earned {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .milestone-badge.next {
            background: var(--bg-elevated);
            color: var(--text-muted);
            border: 1px dashed var(--border);
        }

        .milestone-progress {
            margin-top: 12px;
        }

        .milestone-progress-bar {
            height: 6px;
            background: var(--bg-elevated);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .milestone-progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .milestone-progress-text {
            font-size: 12px;
            color: var(--text-muted);
        }

        .milestone-current {
            font-weight: 600;
            color: var(--text-primary);
        }

        @media (max-width: 1200px) {
            .comparison-metrics {
                grid-template-columns: repeat(2, 1fr);
            }
            .records-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .milestones-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .comparison-metrics {
                grid-template-columns: 1fr;
            }
            .records-grid {
                grid-template-columns: 1fr;
            }
            .milestones-grid {
                grid-template-columns: 1fr;
            }
            .time-range-selector {
                flex-wrap: wrap;
            }
        }

        /* Alerts Section */
        .alerts-section {
            margin: 32px 0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
        }

        .alerts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
        }

        .alert-card {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .alert-card.warning {
            background: rgba(245, 158, 11, 0.08);
            border-color: rgba(245, 158, 11, 0.2);
        }

        .alert-card.success {
            background: rgba(16, 185, 129, 0.08);
            border-color: rgba(16, 185, 129, 0.2);
        }

        .alert-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .alert-card.warning .alert-icon {
            background: rgba(245, 158, 11, 0.15);
        }

        .alert-card.success .alert-icon {
            background: rgba(16, 185, 129, 0.15);
        }

        .alert-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .alert-message {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 15px;
            font-weight: 600;
        }

        .chart-period {
            font-size: 12px;
            color: var(--text-muted);
            padding: 4px 10px;
            background: var(--bg-elevated);
            border-radius: 4px;
        }

        .chart-container {
            height: 220px;
            position: relative;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-header-icon {
            font-size: 18px;
        }

        .stat-header-title {
            font-size: 15px;
            font-weight: 600;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .stat-value {
            font-size: 15px;
            font-weight: 600;
        }

        /* Heatmap */
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .heatmap-day {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 500;
        }

        .heatmap-day .day-label {
            color: var(--text-muted);
            font-size: 10px;
            margin-bottom: 4px;
        }

        .heatmap-day .day-value {
            font-size: 14px;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .score-hero {
                grid-template-columns: 1fr;
            }

            .key-metrics {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 640px) {
            .container {
                padding: 16px;
            }

            .key-metrics {
                grid-template-columns: 1fr;
            }

            .score-breakdown {
                flex-wrap: wrap;
            }
        }

        /* Loading state */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: var(--text-muted);
        }

        /* Settings Button */
        .settings-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 16px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .settings-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Goals Summary Bar */
        .goals-summary {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 24px;
        }

        .goals-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .goals-summary-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .goals-summary-score {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .goals-summary-dots {
            display: flex;
            gap: 4px;
        }

        .goals-summary-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--bg-elevated);
        }

        .goals-summary-dot.achieved {
            background: var(--success);
        }

        .goals-summary-text {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .goals-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .goals-category {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .goals-category-label {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
            min-width: 70px;
        }

        .goals-category-items {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .goal-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }

        .goal-chip.achieved {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .goal-chip.missed {
            background: rgba(239, 68, 68, 0.1);
            color: var(--text-muted);
        }

        .goal-chip svg {
            width: 12px;
            height: 12px;
        }

        /* Progress Bar in Metric Cards */
        .metric-progress {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .metric-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .metric-progress-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .metric-progress-value {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .metric-progress-bar {
            height: 4px;
            background: var(--bg-elevated);
            border-radius: 2px;
            overflow: hidden;
        }

        .metric-progress-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .metric-progress-fill.low {
            background: var(--danger);
        }

        .metric-progress-fill.medium {
            background: var(--warning);
        }

        .metric-progress-fill.high {
            background: var(--success);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.2s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            background: var(--bg-card);
        }

        .modal-footer-left {
            display: flex;
            gap: 8px;
        }

        .modal-footer-right {
            display: flex;
            gap: 8px;
        }

        /* Form Elements */
        .form-section {
            margin-bottom: 24px;
        }

        .form-section:last-child {
            margin-bottom: 0;
        }

        .form-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .form-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .form-row:last-child {
            border-bottom: none;
        }

        .form-label {
            flex: 1;
        }

        .form-label-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .form-label-hint {
            font-size: 12px;
            color: var(--text-muted);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-input {
            width: 100px;
            padding: 8px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            text-align: right;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-unit {
            font-size: 12px;
            color: var(--text-muted);
            min-width: 60px;
        }

        .form-toggle {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .form-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .form-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-elevated);
            border-radius: 24px;
            transition: 0.2s;
        }

        .form-toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: var(--text-muted);
            border-radius: 50%;
            transition: 0.2s;
        }

        .form-toggle input:checked + .form-toggle-slider {
            background: var(--accent);
        }

        .form-toggle input:checked + .form-toggle-slider:before {
            background: white;
            transform: translateX(20px);
        }

        /* Buttons */
        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-light);
        }

        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        /* HRV Card Enhancement */
        .metric-card.hrv .metric-icon {
            background: rgba(16, 185, 129, 0.15);
        }

        .metric-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 8px;
        }

        .metric-status.normal {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .metric-status.low {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .metric-status.high {
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent);
        }

        /* Additional responsive adjustments */
        @media (max-width: 640px) {
            .goals-categories {
                grid-template-columns: 1fr;
            }

            .modal {
                width: 95%;
                max-height: 90vh;
            }

            .form-row {
                flex-wrap: wrap;
            }

            .form-label {
                flex-basis: 100%;
                margin-bottom: 8px;
            }
        }

        /* ===== Tab Navigation Styles ===== */
        .tab-nav {
            display: flex;
            justify-content: center;
            gap: 4px;
            padding: 0;
            background: transparent;
            margin-bottom: 24px;
        }

        .tab-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 6px;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
        }

        .tab-btn:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--accent);
            color: white;
        }

        .tab-btn svg {
            width: 16px;
            height: 16px;
        }

        .tab-btn .tab-label {
            display: inline;
        }

        .tab-content {
            display: none !important;
        }

        .tab-content.active {
            display: block !important;
        }

        /* Ensure goals-summary respects tab visibility */
        .tab-content:not(.active) .goals-summary {
            display: none !important;
        }

        /* Tab Navigation Responsive */
        @media (max-width: 768px) {
            .tab-nav {
                gap: 4px;
                overflow-x: auto;
                justify-content: flex-start;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                padding-bottom: 4px;
            }

            .tab-nav::-webkit-scrollbar {
                display: none;
            }

            .tab-btn {
                padding: 8px 12px;
                flex-shrink: 0;
            }

            .tab-btn .tab-label {
                display: none;
            }

            .tab-btn.active .tab-label {
                display: inline;
            }
        }

        @media (max-width: 480px) {
            .tab-btn {
                padding: 8px 10px;
            }
        }

        /* ===== Sleep Tab Styles ===== */
        .sleep-overview {
            margin-bottom: 24px;
        }

        .sleep-overview .section-header {
            margin-bottom: 20px;
        }

        /* ===== Lifestyle Tab Styles ===== */
        .checkin-section-inline {
            margin-bottom: 24px;
        }

        .checkin-inline-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .checkin-inline-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
        }

        .checkin-inline-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .stress-recovery-section,
        .body-metrics-section {
            margin-bottom: 24px;
        }

        .stress-recovery-grid,
        .body-metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        @media (max-width: 1024px) {
            .checkin-inline-grid {
                grid-template-columns: 1fr;
            }

            .stress-recovery-grid,
            .body-metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .stress-recovery-grid,
            .body-metrics-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* ===== Morning Coach Styles ===== */
        .morning-coach {
            margin-bottom: 32px;
        }

        .coach-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .coach-greeting {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent) 0%, var(--success) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .coach-date {
            font-size: 14px;
            color: var(--text-muted);
        }

        .coach-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 24px 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .coach-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .coach-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
        }

        .coach-card.full-width {
            grid-column: 1 / -1;
        }

        .coach-card-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        /* Readiness Card */
        .readiness-main {
            display: flex;
            align-items: center;
            gap: 24px;
            margin-bottom: 20px;
        }

        .readiness-score-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 3px solid;
        }

        .readiness-score-value {
            font-size: 32px;
            font-weight: 700;
        }

        .readiness-dots {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }

        .readiness-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .readiness-dot.active {
            background: currentColor;
        }

        .readiness-info {
            flex: 1;
        }

        .readiness-label {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .readiness-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Recovery Factors */
        .recovery-factors {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .recovery-factor {
            background: var(--bg-elevated);
            border-radius: 10px;
            padding: 14px;
            text-align: center;
        }

        .recovery-factor.good {
            border-left: 3px solid var(--success);
        }

        .recovery-factor.normal {
            border-left: 3px solid var(--text-muted);
        }

        .recovery-factor.warning {
            border-left: 3px solid var(--warning);
        }

        .recovery-factor.low {
            border-left: 3px solid var(--danger);
        }

        .recovery-factor-icon {
            width: 24px;
            height: 24px;
            margin: 0 auto 8px;
            color: var(--text-secondary);
        }

        .recovery-factor-value {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .recovery-factor-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .recovery-factor-status {
            font-size: 10px;
            margin-top: 4px;
            font-weight: 500;
        }

        /* Workout Suggestion */
        .workout-suggestion {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: 10px;
            margin-top: 16px;
        }

        .workout-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .workout-icon svg {
            width: 20px;
            height: 20px;
        }

        .workout-info {
            flex: 1;
        }

        .workout-label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .workout-duration {
            font-size: 12px;
            color: var(--text-muted);
        }

        .workout-reason {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Priority Card */
        .priority-card {
            border-left: 4px solid;
        }

        .priority-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .priority-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .priority-icon svg {
            width: 20px;
            height: 20px;
        }

        .priority-title {
            font-size: 16px;
            font-weight: 600;
        }

        .priority-action {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .priority-reason {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .summary-value {
            font-size: 13px;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .coach-grid {
                grid-template-columns: 1fr;
            }

            .recovery-factors {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .readiness-main {
                flex-direction: column;
                text-align: center;
            }

            .recovery-factors {
                grid-template-columns: 1fr 1fr;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ===== Check-in FAB and Modal ===== */
        .checkin-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            transition: all 0.2s;
        }

        .checkin-fab:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.5);
        }

        .checkin-fab svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        .checkin-fab.not-checked-in {
            animation: fabPulse 2s infinite;
        }

        .checkin-fab.checked-in {
            background: var(--success);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        @keyframes fabPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        .checkin-fab-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 20px;
            height: 20px;
            background: var(--danger);
            border-radius: 50%;
            font-size: 11px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Check-in Modal Styles */
        .checkin-modal .modal {
            max-width: 500px;
        }

        .checkin-section {
            margin-bottom: 28px;
        }

        .checkin-section:last-child {
            margin-bottom: 0;
        }

        .checkin-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 14px;
        }

        /* Workout Yes/No Toggle */
        .workout-toggle {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .workout-toggle-btn {
            flex: 1;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .workout-toggle-btn:hover {
            border-color: var(--accent);
        }

        .workout-toggle-btn.selected {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent);
        }

        .workout-toggle-btn.selected.no {
            border-color: var(--text-muted);
            background: var(--bg-card);
            color: var(--text-secondary);
        }

        /* Workout Details */
        .workout-details {
            display: none;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: 12px;
            margin-top: 12px;
        }

        .workout-details.visible {
            display: block;
        }

        .workout-types {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .workout-type-btn {
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .workout-type-btn:hover {
            border-color: var(--accent);
        }

        .workout-type-btn.selected {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent);
        }

        .workout-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 12px;
        }

        .workout-row label {
            font-size: 13px;
            color: var(--text-secondary);
            min-width: 70px;
        }

        .workout-duration-input {
            width: 80px;
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            text-align: center;
        }

        .workout-duration-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .intensity-btns {
            display: flex;
            gap: 8px;
            flex: 1;
        }

        .intensity-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .intensity-btn:hover {
            border-color: var(--accent);
        }

        .intensity-btn.selected {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent);
        }

        /* Energy Rating */
        .energy-rating {
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }

        .energy-btn {
            flex: 1;
            padding: 16px 8px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-elevated);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .energy-btn:hover {
            border-color: var(--accent);
        }

        .energy-btn.selected {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.25);
            transform: scale(1.08);
            box-shadow: 0 0 12px rgba(99, 102, 241, 0.4);
        }

        .energy-btn.selected .energy-value {
            color: var(--accent-light);
        }

        .energy-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .energy-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .energy-summary {
            font-size: 12px;
            font-weight: 500;
            color: var(--accent-light);
            margin-left: 8px;
        }

        .energy-logs {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .energy-log-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--bg-elevated);
            border-radius: 12px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .energy-log-level {
            font-weight: 600;
            color: var(--accent-light);
        }

        .energy-log-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .energy-log-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0 2px;
            font-size: 14px;
            line-height: 1;
        }

        .energy-log-remove:hover {
            color: var(--danger);
        }

        /* Tags */
        .tags-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tag-btn:hover {
            border-color: var(--text-muted);
        }

        .tag-btn.selected {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent);
        }

        .tag-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Notes */
        .notes-textarea {
            width: 100%;
            padding: 14px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .notes-counter {
            text-align: right;
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        /* Streak Display */
        .checkin-streak {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: 8px;
            margin-top: 16px;
        }

        .checkin-streak svg {
            width: 18px;
            height: 18px;
            color: var(--warning);
        }

        .checkin-streak-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .checkin-streak-value {
            color: var(--warning);
            font-weight: 700;
        }

        /* Header Check-in Indicator */
        .header-checkin-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .header-checkin-btn:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .header-checkin-btn.checked {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--success);
        }

        .header-checkin-btn svg {
            width: 16px;
            height: 16px;
        }

        /* AI Insights Section */
        .ai-insights-section {
            margin: 32px 0;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .insight-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
        }

        .insight-card.daily-insight {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, var(--bg-card) 100%);
            border-color: rgba(99, 102, 241, 0.2);
        }

        .insight-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .insight-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-light);
        }

        .insight-icon svg {
            width: 20px;
            height: 20px;
        }

        .insight-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .insight-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .insight-content {
            margin-bottom: 16px;
        }

        .insight-text {
            font-size: 15px;
            color: var(--text-primary);
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .insight-action {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px 14px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 10px;
            border-left: 3px solid var(--accent);
        }

        .insight-action-icon {
            color: var(--accent-light);
            flex-shrink: 0;
            margin-top: 2px;
        }

        .insight-action-icon svg {
            width: 16px;
            height: 16px;
        }

        .insight-action-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .insight-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .insight-datapoint {
            font-size: 12px;
            color: var(--text-muted);
        }

        .insight-refresh {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .insight-refresh:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .insight-refresh svg {
            width: 14px;
            height: 14px;
        }

        .insight-refresh.loading svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Prediction Card */
        .prediction-card {
            display: flex;
            flex-direction: column;
        }

        .prediction-value {
            text-align: center;
            padding: 20px 0;
        }

        .prediction-score {
            font-size: 48px;
            font-weight: 700;
            color: var(--accent-light);
            line-height: 1;
        }

        .prediction-label {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .prediction-confidence {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .confidence-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .confidence-dot.high { background: var(--success); }
        .confidence-dot.medium { background: var(--warning); }
        .confidence-dot.low { background: var(--danger); }

        .prediction-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .prediction-item {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .prediction-item strong {
            color: var(--text-primary);
            font-weight: 500;
        }

        .prediction-warning {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 8px;
            font-size: 12px;
            color: var(--warning);
        }

        .prediction-warning svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
            margin-top: 1px;
        }

        /* Ask AI Section */
        .ask-ai-section {
            margin-top: 20px;
        }

        .ask-ai-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
        }

        .ask-ai-input-wrapper {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .ask-ai-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .ask-ai-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .ask-ai-input::placeholder {
            color: var(--text-muted);
        }

        .ask-ai-btn {
            padding: 12px 20px;
            background: var(--accent);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ask-ai-btn:hover {
            background: var(--accent-light);
        }

        .ask-ai-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ask-ai-btn svg {
            width: 16px;
            height: 16px;
        }

        .ask-ai-examples {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .ask-ai-example {
            padding: 6px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .ask-ai-example:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--accent);
        }

        .ask-ai-response {
            display: none;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: 10px;
            border-left: 3px solid var(--accent);
        }

        .ask-ai-response.visible {
            display: block;
        }

        .ask-ai-response-text {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .ask-ai-response-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-muted);
        }

        .ask-ai-response-loading svg {
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        /* ===== Recovery Protocol Card ===== */
        .recovery-protocol {
            margin-bottom: 20px;
        }

        .recovery-protocol-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            border-left: 4px solid var(--warning);
        }

        .recovery-protocol-card.critical {
            border-left-color: var(--danger);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, var(--bg-card) 100%);
        }

        .recovery-protocol-card.warning {
            border-left-color: var(--warning);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, var(--bg-card) 100%);
        }

        .recovery-protocol-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .recovery-protocol-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(245, 158, 11, 0.15);
        }

        .recovery-protocol-card.critical .recovery-protocol-icon {
            background: rgba(239, 68, 68, 0.15);
        }

        .recovery-protocol-icon svg {
            width: 20px;
            height: 20px;
            color: var(--warning);
        }

        .recovery-protocol-card.critical .recovery-protocol-icon svg {
            color: var(--danger);
        }

        .recovery-protocol-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .recovery-protocol-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .recovery-protocol-triggers {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .recovery-trigger-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .recovery-trigger-badge.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .recovery-trigger-badge.critical {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .recovery-recommendations {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .recovery-recommendation {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: 10px;
        }

        .recovery-recommendation-icon {
            width: 28px;
            height: 28px;
            min-width: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
        }

        .recovery-recommendation-icon svg {
            width: 14px;
            height: 14px;
            color: var(--text-secondary);
        }

        .recovery-recommendation-text {
            font-size: 13px;
            color: var(--text-primary);
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .recovery-recommendations {
                grid-template-columns: 1fr;
            }
        }

        /* ===== Bedtime Reminder Card ===== */
        .bedtime-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, var(--bg-card) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .bedtime-main {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 16px;
        }

        .bedtime-time {
            font-size: 36px;
            font-weight: 700;
            color: #8b5cf6;
        }

        .bedtime-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .bedtime-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .bedtime-detail {
            text-align: center;
            padding: 8px;
            background: var(--bg-elevated);
            border-radius: 8px;
        }

        .bedtime-detail-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .bedtime-detail-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .bedtime-winddown {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 8px;
            font-size: 13px;
            color: #8b5cf6;
        }

        .bedtime-winddown svg {
            width: 16px;
            height: 16px;
        }

        .bedtime-edit {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .bedtime-edit input {
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 12px;
            width: 80px;
        }

        .bedtime-edit button {
            padding: 4px 10px;
            border: none;
            border-radius: 4px;
            background: var(--accent);
            color: white;
            font-size: 12px;
            cursor: pointer;
        }

        /* ===== Goal Suggestions ===== */
        .goal-suggestions {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: 12px;
            border: 1px dashed var(--border);
        }

        .goal-suggestions-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .goal-suggestions-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .goal-suggestions-icon svg {
            width: 16px;
            height: 16px;
            color: var(--accent);
        }

        .goal-suggestions-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .goal-suggestion-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .goal-suggestion-item:last-child {
            margin-bottom: 0;
        }

        .goal-suggestion-text {
            font-size: 13px;
            color: var(--text-primary);
            flex: 1;
        }

        .goal-suggestion-actions {
            display: flex;
            gap: 8px;
        }

        .goal-suggestion-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .goal-suggestion-btn.apply {
            background: var(--accent);
            color: white;
        }

        .goal-suggestion-btn.apply:hover {
            background: var(--accent-dark);
        }

        .goal-suggestion-btn.later {
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }

        .goal-suggestion-btn.later:hover {
            background: var(--bg-secondary);
        }

        /* ===== Pattern Badge for Correlations ===== */
        .correlation-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-left: 8px;
        }

        .correlation-badge.pattern {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent);
        }

        .correlation-badge.daily {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .correlation-confidence {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* Correlations Grid */
        .correlations-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 20px;
        }

        .correlation-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }

        .correlation-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .correlation-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-elevated);
        }

        .correlation-icon svg {
            width: 16px;
            height: 16px;
            color: var(--text-secondary);
        }

        .correlation-icon.positive { background: rgba(16, 185, 129, 0.15); }
        .correlation-icon.positive svg { color: var(--success); }
        .correlation-icon.negative { background: rgba(239, 68, 68, 0.15); }
        .correlation-icon.negative svg { color: var(--danger); }
        .correlation-icon.warning { background: rgba(245, 158, 11, 0.15); }
        .correlation-icon.warning svg { color: var(--warning); }

        .correlation-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .correlation-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .correlation-recommendation {
            margin-top: 10px;
            padding: 8px 10px;
            background: var(--bg-elevated);
            border-radius: 6px;
            font-size: 12px;
            color: var(--accent-light);
        }

        @media (max-width: 900px) {
            .insights-grid {
                grid-template-columns: 1fr;
            }
            .correlations-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ===== Smart Health Journal Styles ===== */

        /* Smart Journal Section */
        .smart-journal-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }

        .journal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px 24px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(99, 102, 241, 0.08) 100%);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .journal-header:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.12) 0%, rgba(99, 102, 241, 0.12) 100%);
        }

        .journal-header-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(99, 102, 241, 0.2) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #8b5cf6;
        }

        .journal-header-text {
            flex: 1;
        }

        .journal-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .journal-subtitle {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .journal-expand {
            color: var(--text-muted);
            transition: transform 0.3s;
        }

        .journal-header.expanded .journal-expand {
            transform: rotate(180deg);
        }

        .journal-content {
            display: none;
            padding: 24px;
        }

        .journal-content.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* Evening Check-in Card */
        .evening-checkin-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, var(--bg-elevated) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .checkin-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .checkin-card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .checkin-card-title svg {
            width: 20px;
            height: 20px;
            color: #8b5cf6;
        }

        .checkin-card-time {
            font-size: 12px;
            color: var(--text-muted);
            padding: 4px 10px;
            background: var(--bg-card);
            border-radius: 20px;
        }

        .checkin-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .checkin-status-badge.completed {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .checkin-status-badge.pending {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        /* Lifestyle Factor Row */
        .lifestyle-factor {
            margin-bottom: 20px;
        }

        .lifestyle-factor:last-child {
            margin-bottom: 0;
        }

        .factor-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .factor-label svg {
            width: 16px;
            height: 16px;
        }

        /* Chip Selection */
        .chip-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .chip {
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chip:hover {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.05);
        }

        .chip.selected {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-light);
        }

        .chip.selected.good {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .chip.selected.warning {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .chip.selected.bad {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        /* Stress Scale */
        .stress-scale {
            display: flex;
            gap: 8px;
        }

        .stress-btn {
            width: 44px;
            height: 44px;
            border: 2px solid var(--border);
            border-radius: 50%;
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stress-btn:hover {
            border-color: var(--accent);
        }

        .stress-btn.selected {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-light);
        }

        .stress-btn.selected.low {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .stress-btn.selected.medium {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .stress-btn.selected.high {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        /* Save Button */
        .save-checkin-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 24px;
        }

        .save-checkin-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .save-checkin-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Morning Reflection Card */
        .morning-reflection-card {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.05) 0%, var(--bg-elevated) 100%);
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .morning-reflection-card .checkin-card-title svg {
            color: #fbbf24;
        }

        /* Energy Emoji Scale */
        .energy-emoji-scale {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .energy-emoji-btn {
            width: 56px;
            height: 56px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-card);
            font-size: 28px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .energy-emoji-btn:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .energy-emoji-btn.selected {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.15);
            transform: scale(1.1);
        }

        /* Patterns Section */
        .patterns-section {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .patterns-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .patterns-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .patterns-title svg {
            width: 18px;
            height: 18px;
            color: #6366f1;
        }

        .patterns-days {
            font-size: 12px;
            color: var(--text-muted);
            padding: 4px 10px;
            background: var(--bg-card);
            border-radius: 20px;
        }

        .pattern-item {
            padding: 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .pattern-item:last-child {
            margin-bottom: 0;
        }

        .pattern-item.negative {
            border-left: 3px solid #ef4444;
        }

        .pattern-item.positive {
            border-left: 3px solid #10b981;
        }

        .pattern-factor {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .pattern-factor svg {
            width: 16px;
            height: 16px;
        }

        .pattern-impact {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .pattern-confidence {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Best Sleep Factors */
        .best-sleep-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .best-sleep-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .best-sleep-factors {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .best-factor-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 20px;
            font-size: 12px;
            color: #10b981;
        }

        .best-factor-chip .percentage {
            font-weight: 600;
        }

        /* Smart Prompt Card */
        .smart-prompt-card {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0%, var(--bg-card) 100%);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .smart-prompt-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 16px;
        }

        .smart-prompt-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(245, 158, 11, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #f59e0b;
            flex-shrink: 0;
        }

        .smart-prompt-message {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .smart-prompt-causes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .cause-chip {
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cause-chip:hover {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .cause-chip.selected {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        /* Journal Streaks */
        .journal-streaks {
            display: flex;
            gap: 16px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .journal-streak-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-card);
            border-radius: 8px;
        }

        .journal-streak-item svg {
            width: 18px;
            height: 18px;
            color: #f59e0b;
        }

        .journal-streak-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .journal-streak-value {
            font-size: 14px;
            font-weight: 600;
            color: #f59e0b;
        }

        /* Enough Data Message */
        .not-enough-data {
            text-align: center;
            padding: 24px;
            color: var(--text-muted);
        }

        .not-enough-data-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            border-radius: 50%;
            background: var(--bg-elevated);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }

        .not-enough-data-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .not-enough-data-text {
            font-size: 13px;
        }

        @media (max-width: 600px) {
            .chip-group {
                gap: 6px;
            }
            .chip {
                padding: 8px 12px;
                font-size: 12px;
            }
            .stress-scale {
                gap: 6px;
            }
            .stress-btn {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }
            .energy-emoji-scale {
                gap: 8px;
            }
            .energy-emoji-btn {
                width: 48px;
                height: 48px;
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1 id="dashboardTitle">Health Dashboard</h1>
                <p class="subtitle">Your fitness metrics at a glance</p>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <div class="last-updated" id="lastUpdated">Loading...</div>
                <button class="settings-btn" onclick="openSettingsModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/>
                    </svg>
                    Settings
                </button>
            </div>
        </header>

        <!-- Today's Scores Hero Section -->
        <section class="scores-hero" id="scoresHero">
            <!-- Sleep Score Card -->
            <div class="score-card sleep">
                <div class="score-card-header">
                    <div class="score-card-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                    <span class="score-card-title">Sleep</span>
                </div>
                <div class="score-card-value" id="todaySleepScore">--</div>
                <div class="score-card-status good" id="sleepStatus">
                    <span id="sleepStatusText">Loading</span>
                </div>
                <div class="score-card-avg" id="sleepAvgText">7-day avg: --</div>
                <div class="score-card-secondary" id="sleepSecondary">Deep: -- min</div>
            </div>

            <!-- Readiness Score Card -->
            <div class="score-card readiness">
                <div class="score-card-header">
                    <div class="score-card-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                    </div>
                    <span class="score-card-title">Readiness</span>
                </div>
                <div class="score-card-value" id="todayReadinessScore">--</div>
                <div class="score-card-status good" id="readinessStatus">
                    <span id="readinessStatusText">Loading</span>
                </div>
                <div class="score-card-avg" id="readinessAvgText">7-day avg: --</div>
                <div class="score-card-secondary" id="readinessSecondary">HRV: -- ms</div>
            </div>

            <!-- Activity Score Card -->
            <div class="score-card activity">
                <div class="score-card-header">
                    <div class="score-card-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                        </svg>
                    </div>
                    <span class="score-card-title">Activity</span>
                </div>
                <div class="score-card-value" id="todayActivityScore">--</div>
                <div class="score-card-status good" id="activityStatus">
                    <span id="activityStatusText">Loading</span>
                </div>
                <div class="score-card-avg" id="activityAvgText">7-day avg: --</div>
                <div class="score-card-secondary" id="activitySecondary">Steps: --</div>
            </div>
        </section>

        <!-- Today's AI Coach Insight -->
        <section class="insight-hero" id="insightHero">
            <div class="insight-hero-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 16v-4M12 8h.01"/>
                </svg>
            </div>
            <div class="insight-hero-text">
                <div class="insight-hero-label">
                    AI Coach
                    <span class="insight-refresh-btn" onclick="refreshAIInsight()" title="Refresh insight">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <path d="M23 4v6h-6M1 20v-6h6"/>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                    </span>
                </div>
                <div class="insight-hero-message" id="heroInsightText">Analyzing your data...</div>
                <div class="insight-hero-recommendation" id="heroRecommendation"></div>
                <div class="insight-hero-pattern" id="heroPattern"></div>
            </div>
        </section>

        <!-- Ask AI Section -->
        <section class="ask-ai-section" id="askAiSection">
            <div class="ask-ai-header">
                <div class="ask-ai-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                </div>
                <div>
                    <div class="ask-ai-title">Ask AI Coach</div>
                    <div class="ask-ai-subtitle">Get personalized answers about your health data</div>
                </div>
            </div>
            <div class="ask-ai-input-row">
                <input type="text" class="ask-ai-input" id="askAiInput"
                       placeholder="e.g., Why is my HRV low? How can I improve my deep sleep?"
                       onkeypress="if(event.key==='Enter') askAIQuestion()">
                <button class="ask-ai-btn" id="askAiBtn" onclick="askAIQuestion()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <line x1="22" y1="2" x2="11" y2="13"/>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                    </svg>
                    Ask
                </button>
            </div>
            <div class="ask-ai-suggestions">
                <span class="ask-ai-suggestion" onclick="askSuggestion(this)">Why is my HRV low?</span>
                <span class="ask-ai-suggestion" onclick="askSuggestion(this)">How can I improve deep sleep?</span>
                <span class="ask-ai-suggestion" onclick="askSuggestion(this)">Am I ready for a hard workout?</span>
                <span class="ask-ai-suggestion" onclick="askSuggestion(this)">What's affecting my recovery?</span>
            </div>
            <div class="ask-ai-response" id="askAiResponse">
                <div class="ask-ai-response-header">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 16v-4M12 8h.01"/>
                    </svg>
                    AI Coach Response
                </div>
                <div class="ask-ai-response-text" id="askAiResponseText"></div>
            </div>
        </section>

        <!-- Quick Stats Row -->
        <section class="quick-stats" id="quickStats">
            <div class="quick-stat">
                <div class="quick-stat-icon hrv">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                </div>
                <div class="quick-stat-content">
                    <div class="quick-stat-value" id="qsHrv">-- ms</div>
                    <div class="quick-stat-label">HRV</div>
                </div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-icon deep">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <rect x="3" y="11" width="18" height="10" rx="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                </div>
                <div class="quick-stat-content">
                    <div class="quick-stat-value" id="qsDeep">-- min</div>
                    <div class="quick-stat-label">Deep Sleep</div>
                </div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-icon rhr">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                </div>
                <div class="quick-stat-content">
                    <div class="quick-stat-value" id="qsRhr">-- bpm</div>
                    <div class="quick-stat-label">Resting HR</div>
                </div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-icon steps">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <path d="M13 4v16M7 4v16M19 4v16"/>
                    </svg>
                </div>
                <div class="quick-stat-content">
                    <div class="quick-stat-value" id="qsSteps">--</div>
                    <div class="quick-stat-label">Today's Steps</div>
                </div>
            </div>
        </section>

        <!-- 7-Day Trend -->
        <section class="trend-section" id="trendSection">
            <div class="trend-header">
                <span class="trend-title">7-Day Trend</span>
                <div class="trend-toggle">
                    <button class="trend-toggle-btn active" data-trend="sleep" onclick="switchTrend('sleep')">Sleep</button>
                    <button class="trend-toggle-btn" data-trend="steps" onclick="switchTrend('steps')">Steps</button>
                    <button class="trend-toggle-btn" data-trend="hrv" onclick="switchTrend('hrv')">HRV</button>
                </div>
            </div>
            <div class="trend-chart">
                <canvas id="trendSparkline"></canvas>
            </div>
        </section>

        <!-- Collapsible Alerts -->
        <section class="alerts-collapsible" id="alertsCollapsible">
            <div class="alerts-header" id="alertsHeader" onclick="toggleAlerts()">
                <div class="alerts-header-left">
                    <div class="alerts-badge warning" id="alertsBadge">0</div>
                    <span class="alerts-title" id="alertsTitle">Health Alerts</span>
                </div>
                <div class="alerts-expand">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
            </div>
            <div class="alerts-content" id="alertsContent">
                <div class="alerts-grid" id="alertsGrid">
                    <div class="loading">Loading alerts...</div>
                </div>
            </div>
        </section>

        <!-- Expandable Details: Sleep -->
        <section class="details-section" id="sleepDetails">
            <div class="details-header" onclick="toggleDetails('sleepDetails')">
                <div class="details-icon sleep">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                </div>
                <span class="details-title">Sleep Details</span>
                <div class="details-expand">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
            </div>
            <div class="details-content" id="sleepDetailsContent">
                <!-- Sleep metrics grid -->
                <div class="key-metrics" style="margin-bottom: 24px;">
                    <div class="metric-card">
                        <div class="metric-icon" style="background: rgba(139, 92, 246, 0.15);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                            </svg>
                        </div>
                        <div class="metric-value" id="sleepTabScore">--</div>
                        <div class="metric-label">Sleep Score</div>
                        <div class="metric-change positive" id="sleepTabTrend">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon" style="background: rgba(139, 92, 246, 0.15);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2">
                                <rect x="3" y="11" width="18" height="10" rx="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                        </div>
                        <div class="metric-value" id="sleepTabDeep">-- min</div>
                        <div class="metric-label">Deep Sleep</div>
                        <div class="metric-change" id="sleepTabDeepAvg">Avg: --</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon" style="background: rgba(99, 102, 241, 0.15);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                        </div>
                        <div class="metric-value" id="sleepTabRem">-- min</div>
                        <div class="metric-label">REM Sleep</div>
                        <div class="metric-change" id="sleepTabRemAvg">Avg: --</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon" style="background: rgba(16, 185, 129, 0.15);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                            </svg>
                        </div>
                        <div class="metric-value" id="sleepTabHrv">-- ms</div>
                        <div class="metric-label">HRV</div>
                        <div class="metric-change positive" id="sleepTabHrvBaseline">Baseline: --</div>
                    </div>
                </div>
                <!-- Sleep charts -->
                <div class="charts-grid" style="margin-bottom: 24px;">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Sleep Stages</div>
                            <div class="chart-period">Last night breakdown</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="sleepStagesChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Sleep Efficiency</div>
                            <div class="chart-period">7-day trend</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="sleepEfficiencyChart"></canvas>
                        </div>
                    </div>
                </div>
                <!-- Last Night Summary -->
                <div class="coach-card">
                    <div class="coach-card-title">Last Night Summary</div>
                    <div class="summary-grid" id="sleepTabLastNight">
                        <div>
                            <div class="summary-item">
                                <span class="summary-label">Total Sleep</span>
                                <span class="summary-value" id="sleepTabTotal">-- hrs</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Efficiency</span>
                                <span class="summary-value" id="sleepTabEfficiency">--%</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Breath Rate</span>
                                <span class="summary-value" id="sleepTabBreath">--/min</span>
                            </div>
                        </div>
                        <div>
                            <div class="summary-item">
                                <span class="summary-label">Bedtime</span>
                                <span class="summary-value" id="sleepTabBedtime">--:--</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Wake Time</span>
                                <span class="summary-value" id="sleepTabWake">--:--</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Restfulness</span>
                                <span class="summary-value" id="sleepTabRestful">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Expandable Details: Activity -->
        <section class="details-section" id="activityDetails">
            <div class="details-header" onclick="toggleDetails('activityDetails')">
                <div class="details-icon activity">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                </div>
                <span class="details-title">Activity Details</span>
                <div class="details-expand">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
            </div>
            <div class="details-content" id="activityDetailsContent">
                <!-- Activity Metrics -->
                <section class="key-metrics" style="margin-bottom: 24px;">
                    <div class="metric-card">
                        <div class="metric-icon" style="background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M13 4v16M7 4v16M19 4v16"/>
                            </svg>
                        </div>
                        <div class="metric-value" id="avgSteps">--</div>
                        <div class="metric-label">Avg Daily Steps</div>
                        <div class="metric-change" id="stepsChange">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                            </svg>
                        </div>
                        <div class="metric-value" id="activityAvgHr">-- bpm</div>
                        <div class="metric-label">Avg Heart Rate</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                        </div>
                        <div class="metric-value" id="activityActiveDays">--</div>
                        <div class="metric-label">Active Days</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <circle cx="12" cy="5" r="3"/>
                                <line x1="12" y1="22" x2="12" y2="8"/>
                            </svg>
                        </div>
                        <div class="metric-value" id="activityWorkouts">--</div>
                        <div class="metric-label">Workouts (30d)</div>
                    </div>
                </section>
                <!-- Activity Charts -->
                <section class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Daily Steps</div>
                            <div class="chart-period">Last 7 days</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="stepsChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Workouts</div>
                            <div class="chart-period">By type</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="workoutChart"></canvas>
                        </div>
                    </div>
                </section>
                <section class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Heart Rate Trends</div>
                            <div class="chart-period">Last 7 days</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="heartChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Weekly Comparison</div>
                            <div class="chart-period">Steps by week</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="weeklyChart"></canvas>
                        </div>
                    </div>
                </section>
                <!-- Stats Grid -->
                <section class="stats-grid" style="margin-top: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-header-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                            </span>
                            <span class="stat-header-title">Weekly Heatmap</span>
                        </div>
                        <div class="heatmap-grid" id="heatmapGrid"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-header-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                </svg>
                            </span>
                            <span class="stat-header-title">Streaks</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Current Streak</span>
                            <span class="stat-value" id="currentStreak">-- days</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Longest Streak</span>
                            <span class="stat-value" id="longestStreak">-- days</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Best Day</span>
                            <span class="stat-value" id="bestDay">--</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-header-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="20" x2="12" y2="10"/>
                                    <line x1="18" y1="20" x2="18" y2="4"/>
                                    <line x1="6" y1="20" x2="6" y2="16"/>
                                </svg>
                            </span>
                            <span class="stat-header-title">30-Day Totals</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total Steps</span>
                            <span class="stat-value" id="totalSteps">--</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total Calories</span>
                            <span class="stat-value" id="totalCalories">--</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Days Tracked</span>
                            <span class="stat-value" id="daysTracked">--</span>
                        </div>
                    </div>
                </section>
            </div>
        </section>

        <!-- Smart Health Journal -->
        <section class="smart-journal-section" id="smartJournalSection">
            <div class="journal-header" id="journalHeader" onclick="toggleJournalSection()">
                <div class="journal-header-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22">
                        <path d="M12 20h9"/>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                    </svg>
                </div>
                <div class="journal-header-text">
                    <div class="journal-title">Smart Health Journal</div>
                    <div class="journal-subtitle" id="journalSubtitle">Track lifestyle factors that impact your sleep</div>
                </div>
                <div class="journal-expand">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
            </div>
            <div class="journal-content" id="journalContent">

                <!-- Smart Prompt (shown when anomaly detected) -->
                <div class="smart-prompt-card" id="smartPromptCard" style="display: none;">
                    <div class="smart-prompt-header">
                        <div class="smart-prompt-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="12"/>
                                <line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                        </div>
                        <div class="smart-prompt-message" id="smartPromptMessage">Your deep sleep was low. What might have caused this?</div>
                    </div>
                    <div class="smart-prompt-causes" id="smartPromptCauses">
                        <button class="cause-chip" data-cause="late_caffeine" onclick="selectCause('late_caffeine')">Late caffeine</button>
                        <button class="cause-chip" data-cause="alcohol" onclick="selectCause('alcohol')">Alcohol</button>
                        <button class="cause-chip" data-cause="stress" onclick="selectCause('stress')">Stress</button>
                        <button class="cause-chip" data-cause="late_meal" onclick="selectCause('late_meal')">Late meal</button>
                        <button class="cause-chip" data-cause="screen_time" onclick="selectCause('screen_time')">Screen time</button>
                        <button class="cause-chip" data-cause="not_sure" onclick="selectCause('not_sure')">Not sure</button>
                    </div>
                    <button class="save-checkin-btn" style="margin-top: 16px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);" onclick="saveRetroCauseAndDismiss()">Save & Dismiss</button>
                </div>

                <!-- Morning Reflection (shown 6am-11am) -->
                <div class="morning-reflection-card" id="morningReflectionCard" style="display: none;">
                    <div class="checkin-card-header">
                        <div class="checkin-card-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="5"/>
                                <line x1="12" y1="1" x2="12" y2="3"/>
                                <line x1="12" y1="21" x2="12" y2="23"/>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                                <line x1="1" y1="12" x2="3" y2="12"/>
                                <line x1="21" y1="12" x2="23" y2="12"/>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                            </svg>
                            Morning Reflection
                        </div>
                        <div id="morningReflectionStatus"></div>
                    </div>

                    <div class="lifestyle-factor">
                        <div class="factor-label">How's your energy this morning?</div>
                        <div class="energy-emoji-scale" id="morningEnergyScale">
                            <button class="energy-emoji-btn" data-energy="1" onclick="selectMorningEnergy(1)">&#128553;</button>
                            <button class="energy-emoji-btn" data-energy="2" onclick="selectMorningEnergy(2)">&#128532;</button>
                            <button class="energy-emoji-btn" data-energy="3" onclick="selectMorningEnergy(3)">&#128528;</button>
                            <button class="energy-emoji-btn" data-energy="4" onclick="selectMorningEnergy(4)">&#128578;</button>
                            <button class="energy-emoji-btn" data-energy="5" onclick="selectMorningEnergy(5)">&#128522;</button>
                        </div>
                    </div>

                    <div class="lifestyle-factor">
                        <div class="factor-label">How did your sleep feel?</div>
                        <div class="chip-group" id="sleepFeltChips">
                            <button class="chip" data-value="poor" onclick="selectSleepFelt('poor')">Poor</button>
                            <button class="chip" data-value="okay" onclick="selectSleepFelt('okay')">Okay</button>
                            <button class="chip" data-value="good" onclick="selectSleepFelt('good')">Good</button>
                            <button class="chip" data-value="great" onclick="selectSleepFelt('great')">Great</button>
                        </div>
                    </div>

                    <button class="save-checkin-btn" id="saveMorningBtn" onclick="saveMorningReflection()">Save Reflection</button>
                </div>

                <!-- Evening Check-in (shown after 7pm) -->
                <div class="evening-checkin-card" id="eveningCheckinCard">
                    <div class="checkin-card-header">
                        <div class="checkin-card-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                            </svg>
                            Evening Check-in
                        </div>
                        <div id="eveningCheckinStatus"></div>
                    </div>

                    <!-- Caffeine -->
                    <div class="lifestyle-factor">
                        <div class="factor-label">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 8h1a4 4 0 0 1 0 8h-1"/>
                                <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                            </svg>
                            Caffeine today?
                        </div>
                        <div class="chip-group" id="caffeineChips">
                            <button class="chip" data-value="none" onclick="selectCaffeine('none')">None</button>
                            <button class="chip" data-value="morning_only" onclick="selectCaffeine('morning_only')">Morning only</button>
                            <button class="chip" data-value="afternoon" onclick="selectCaffeine('afternoon')">Afternoon</button>
                            <button class="chip" data-value="evening" onclick="selectCaffeine('evening')">Evening</button>
                        </div>
                    </div>

                    <!-- Alcohol -->
                    <div class="lifestyle-factor">
                        <div class="factor-label">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M8 22h8"/>
                                <path d="M12 11v11"/>
                                <path d="M5.2 4a10.8 10.8 0 0 0 13.6 0"/>
                                <path d="M5.2 4L7 2h10l1.8 2"/>
                                <path d="M5.2 4c-1 2-1 4 0 6l.6 1c1 2 2.8 3 4.2 3h4c1.4 0 3.2-1 4.2-3l.6-1c1-2 1-4 0-6"/>
                            </svg>
                            Alcohol?
                        </div>
                        <div class="chip-group" id="alcoholChips">
                            <button class="chip" data-value="none" onclick="selectAlcohol('none')">None</button>
                            <button class="chip" data-value="one_two" onclick="selectAlcohol('one_two')">1-2 drinks</button>
                            <button class="chip" data-value="three_plus" onclick="selectAlcohol('three_plus')">3+</button>
                        </div>
                    </div>

                    <!-- Last Meal Time -->
                    <div class="lifestyle-factor">
                        <div class="factor-label">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/>
                                <path d="M7 2v20"/>
                                <path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3"/>
                                <path d="M18 22v-7"/>
                            </svg>
                            Last meal before bed?
                        </div>
                        <div class="chip-group" id="mealTimeChips">
                            <button class="chip" data-value="three_plus" onclick="selectMealTime('three_plus')">3+ hrs</button>
                            <button class="chip" data-value="one_two" onclick="selectMealTime('one_two')">1-2 hrs</button>
                            <button class="chip" data-value="less_one" onclick="selectMealTime('less_one')">&lt; 1 hr</button>
                        </div>
                    </div>

                    <!-- Screen Time -->
                    <div class="lifestyle-factor">
                        <div class="factor-label">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
                                <line x1="12" y1="18" x2="12.01" y2="18"/>
                            </svg>
                            Screen time before bed?
                        </div>
                        <div class="chip-group" id="screenTimeChips">
                            <button class="chip" data-value="none" onclick="selectScreenTime('none')">None</button>
                            <button class="chip" data-value="under_30" onclick="selectScreenTime('under_30')">&lt; 30 min</button>
                            <button class="chip" data-value="over_30" onclick="selectScreenTime('over_30')">30+ min</button>
                        </div>
                    </div>

                    <!-- Stress Level -->
                    <div class="lifestyle-factor">
                        <div class="factor-label">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z"/>
                                <path d="M8 15h8"/>
                                <path d="M9 9h.01"/>
                                <path d="M15 9h.01"/>
                            </svg>
                            Stress level today?
                        </div>
                        <div class="stress-scale" id="stressScale">
                            <button class="stress-btn" data-stress="1" onclick="selectStress(1)">1</button>
                            <button class="stress-btn" data-stress="2" onclick="selectStress(2)">2</button>
                            <button class="stress-btn" data-stress="3" onclick="selectStress(3)">3</button>
                            <button class="stress-btn" data-stress="4" onclick="selectStress(4)">4</button>
                            <button class="stress-btn" data-stress="5" onclick="selectStress(5)">5</button>
                        </div>
                    </div>

                    <button class="save-checkin-btn" id="saveEveningBtn" onclick="saveEveningCheckin()">Save Check-in</button>
                </div>

                <!-- Patterns Section (shown when 14+ days of data) -->
                <div class="patterns-section" id="patternsSection" style="display: none;">
                    <div class="patterns-header">
                        <div class="patterns-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            </svg>
                            Your Patterns
                        </div>
                        <div class="patterns-days" id="patternsDays">-- days analyzed</div>
                    </div>

                    <div id="patternsList"></div>

                    <div class="best-sleep-section" id="bestSleepSection" style="display: none;">
                        <div class="best-sleep-title">Your best sleep nights had:</div>
                        <div class="best-sleep-factors" id="bestSleepFactors"></div>
                    </div>
                </div>

                <!-- Not Enough Data Message -->
                <div class="not-enough-data" id="notEnoughDataMessage" style="display: none;">
                    <div class="not-enough-data-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                    </div>
                    <div class="not-enough-data-title">Building your patterns...</div>
                    <div class="not-enough-data-text" id="notEnoughDataText">Check in for 14 days to see your personal sleep patterns</div>
                </div>

                <!-- Journal Streaks -->
                <div class="journal-streaks" id="journalStreaks">
                    <div class="journal-streak-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>
                        </svg>
                        <div>
                            <div class="journal-streak-label">Evening Streak</div>
                            <div class="journal-streak-value" id="eveningStreakValue">0 days</div>
                        </div>
                    </div>
                    <div class="journal-streak-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                            <line x1="1" y1="12" x2="3" y2="12"/>
                            <line x1="21" y1="12" x2="23" y2="12"/>
                        </svg>
                        <div>
                            <div class="journal-streak-label">Morning Streak</div>
                            <div class="journal-streak-value" id="morningStreakValue">0 days</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Expandable Details: Nutrition & Check-in (Legacy) -->
        <section class="details-section" id="nutritionDetails">
            <div class="details-header" onclick="toggleDetails('nutritionDetails')">
                <div class="details-icon nutrition">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
                    </svg>
                </div>
                <span class="details-title">Nutrition & Water Tracking</span>
                <div class="details-expand">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
            </div>
            <div class="details-content" id="nutritionDetailsContent">
                <!-- Nutrition content is populated from hidden sections below -->
                <section class="nutrition-section" id="nutritionSectionInline">
                    <div class="nutrition-grid" id="nutritionGridInline"></div>
                </section>
                <section class="checkin-section-inline" id="checkinSectionInline" style="display: none;">
                    <div class="checkin-inline-grid" id="checkinGridInline"></div>
                </section>
            </div>
        </section>

        <!-- Hidden: Legacy Tab Sections (kept for JS compatibility) -->
        <div id="legacyTabs" style="display: none;">

        <!-- ==================== TAB: COACH ==================== -->
        <div class="tab-content" id="tab-coach">

        <!-- Section 1: Greeting & Recovery Alert -->
        <section class="morning-coach" id="morningCoach">
            <div class="coach-header">
                <div class="coach-greeting" id="coachGreeting">Good morning</div>
                <div class="coach-date" id="coachDate"></div>
            </div>

            <!-- Recovery Protocol (shown when recovery is low) -->
            <div class="recovery-protocol" id="recoveryProtocol" style="display: none;">
                <div class="recovery-protocol-card" id="recoveryProtocolCard">
                    <div class="recovery-protocol-header">
                        <div class="recovery-protocol-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                <line x1="12" y1="9" x2="12" y2="13"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                        </div>
                        <div>
                            <div class="recovery-protocol-title" id="recoveryProtocolTitle">Recovery Focus Recommended</div>
                            <div class="recovery-protocol-subtitle" id="recoveryProtocolSubtitle">Your body is showing signs of stress or fatigue</div>
                        </div>
                    </div>
                    <div class="recovery-protocol-triggers" id="recoveryProtocolTriggers"></div>
                    <div class="recovery-recommendations" id="recoveryRecommendations"></div>
                </div>
            </div>

            <!-- Section 2: Today's Status -->
            <div class="coach-section-title">Today's Status</div>
            <div class="coach-grid">
                <!-- Readiness Card -->
                <div class="coach-card" id="readinessCard">
                    <div class="coach-card-title">Today's Readiness</div>
                    <div class="readiness-main">
                        <div class="readiness-score-circle" id="readinessCircle" style="border-color: var(--success); color: var(--success);">
                            <div class="readiness-score-value" id="readinessScoreValue">--</div>
                            <div class="readiness-dots" id="readinessDots"></div>
                        </div>
                        <div class="readiness-info">
                            <div class="readiness-label" id="readinessLabel">Loading...</div>
                            <div class="readiness-description" id="readinessDescription"></div>
                        </div>
                    </div>

                    <div class="coach-card-title" style="margin-top: 20px;">Recovery Factors</div>
                    <div class="recovery-factors" id="recoveryFactors"></div>

                    <div class="workout-suggestion" id="workoutSuggestion"></div>
                </div>

                <!-- Priority Card -->
                <div class="coach-card priority-card" id="priorityCard" style="border-left-color: var(--accent);">
                    <div class="coach-card-title">Your Priority Today</div>
                    <div class="priority-header">
                        <div class="priority-icon" id="priorityIcon" style="background: rgba(99, 102, 241, 0.15);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                        </div>
                        <div class="priority-title" id="priorityTitle">Loading...</div>
                    </div>
                    <div class="priority-action" id="priorityAction"></div>
                    <div class="priority-reason" id="priorityReason"></div>
                </div>

                <!-- Last Night Summary -->
                <div class="coach-card">
                    <div class="coach-card-title">Last Night</div>
                    <div class="summary-grid" id="lastNightSummary">
                        <div>
                            <div class="summary-item">
                                <span class="summary-label">Sleep Score</span>
                                <span class="summary-value" id="lastSleepScore">--</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">HRV</span>
                                <span class="summary-value" id="lastHrv">-- ms</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Deep Sleep</span>
                                <span class="summary-value" id="lastDeep">-- min</span>
                            </div>
                        </div>
                        <div>
                            <div class="summary-item">
                                <span class="summary-label">REM Sleep</span>
                                <span class="summary-value" id="lastRem">-- min</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Efficiency</span>
                                <span class="summary-value" id="lastEfficiency">--%</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Breath Rate</span>
                                <span class="summary-value" id="lastBreath">--/min</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- This Week Summary -->
                <div class="coach-card">
                    <div class="coach-card-title">This Week</div>
                    <div class="summary-grid" id="thisWeekSummary">
                        <div>
                            <div class="summary-item">
                                <span class="summary-label">Workouts</span>
                                <span class="summary-value" id="weekWorkouts">--/4</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Avg Steps</span>
                                <span class="summary-value" id="weekSteps">--</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Active Days</span>
                                <span class="summary-value" id="weekActiveDays">--/7</span>
                            </div>
                        </div>
                        <div>
                            <div class="summary-item">
                                <span class="summary-label">Avg HRV</span>
                                <span class="summary-value" id="weekHrv">-- ms</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Avg Deep</span>
                                <span class="summary-value" id="weekDeep">-- min</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Sleep Avg</span>
                                <span class="summary-value" id="weekSleep">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bedtime Reminder Card -->
                <div class="coach-card bedtime-card" id="bedtimeCard" style="display: none;">
                    <div class="coach-card-title">Optimal Bedtime</div>
                    <div class="bedtime-main">
                        <div>
                            <div class="bedtime-time" id="bedtimeTime">--:-- PM</div>
                            <div class="bedtime-label">Tonight's Target</div>
                        </div>
                    </div>
                    <div class="bedtime-details">
                        <div class="bedtime-detail">
                            <div class="bedtime-detail-value" id="bedtimeTargetSleep">-- hours</div>
                            <div class="bedtime-detail-label">Target Sleep</div>
                        </div>
                        <div class="bedtime-detail">
                            <div class="bedtime-detail-value" id="bedtimeWakeTime">--:-- AM</div>
                            <div class="bedtime-detail-label">Wake Time</div>
                        </div>
                        <div class="bedtime-detail">
                            <div class="bedtime-detail-value" id="bedtimeLatency">-- min</div>
                            <div class="bedtime-detail-label">Avg Latency</div>
                        </div>
                    </div>
                    <div class="bedtime-winddown" id="bedtimeWinddown">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                        <span>Start winding down at <strong id="winddownTime">--:-- PM</strong></span>
                    </div>
                    <div class="bedtime-edit">
                        <span>Wake time:</span>
                        <input type="time" id="wakeTimeInput" value="07:00">
                        <button onclick="updateWakeTime()">Save</button>
                        <span id="bedtimeBasedOn" style="margin-left: auto; font-style: italic;">Based on -- nights</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 3: AI Insights & Patterns -->
        <section class="ai-insights-section" id="aiInsightsSection">
            <div class="coach-section-title">AI Insights & Patterns</div>

            <div class="insights-grid">
                <!-- Daily Insight Card -->
                <div class="insight-card daily-insight" id="dailyInsightCard">
                    <div class="insight-header">
                        <div class="insight-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4M12 8h.01"/>
                            </svg>
                        </div>
                        <div>
                            <div class="insight-title">Today's Insight</div>
                            <div class="insight-subtitle">Personalized for you</div>
                        </div>
                    </div>
                    <div class="insight-content">
                        <div class="insight-text" id="insightText">Analyzing your data...</div>
                        <div class="insight-action" id="insightAction">
                            <div class="insight-action-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9 18 15 12 9 6"/>
                                </svg>
                            </div>
                            <div class="insight-action-text" id="insightActionText">Loading recommendation...</div>
                        </div>
                    </div>
                    <div class="insight-footer">
                        <div class="insight-datapoint" id="insightDatapoint">Based on your health data</div>
                        <button class="insight-refresh" id="refreshInsightBtn" onclick="refreshDailyInsight()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 4v6h-6M1 20v-6h6"/>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                            </svg>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Tomorrow's Prediction Card -->
                <div class="insight-card prediction-card" id="predictionCard">
                    <div class="insight-header">
                        <div class="insight-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                        </div>
                        <div>
                            <div class="insight-title">Tomorrow's Forecast</div>
                            <div class="insight-subtitle">Based on today's data</div>
                        </div>
                    </div>
                    <div class="prediction-value">
                        <div class="prediction-score" id="predictionScore">--</div>
                        <div class="prediction-label">Predicted Readiness</div>
                        <div class="prediction-confidence">
                            <span class="confidence-dot" id="confidenceDot"></span>
                            <span id="confidenceText">Calculating...</span>
                        </div>
                    </div>
                    <div class="prediction-details">
                        <div class="prediction-item" id="predictionRecommendation">
                            <strong>Recommendation:</strong> <span>Loading...</span>
                        </div>
                        <div class="prediction-item" id="predictionTip">
                            <strong>Tip:</strong> <span>Loading...</span>
                        </div>
                        <div class="prediction-warning" id="predictionWarning" style="display: none;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                <line x1="12" y1="9" x2="12" y2="13"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                            <span id="predictionWarningText"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Correlations Grid -->
            <div class="correlations-grid" id="correlationsGrid">
                <!-- Correlations will be populated by JS -->
            </div>

            <!-- Ask AI Section -->
            <div class="ask-ai-section">
                <div class="ask-ai-card">
                    <div class="insight-header">
                        <div class="insight-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                        </div>
                        <div>
                            <div class="insight-title">Ask Your Data</div>
                            <div class="insight-subtitle">Get AI-powered answers about your health</div>
                        </div>
                    </div>
                    <div class="ask-ai-input-wrapper">
                        <input type="text" class="ask-ai-input" id="askAiInput" placeholder="Ask a question about your health data...">
                        <button class="ask-ai-btn" id="askAiBtn" onclick="askAI()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                            Ask
                        </button>
                    </div>
                    <div class="ask-ai-examples">
                        <span class="ask-ai-example" onclick="setAskQuestion('What affects my sleep the most?')">What affects my sleep?</span>
                        <span class="ask-ai-example" onclick="setAskQuestion('How does my step count impact my readiness?')">Steps vs readiness?</span>
                        <span class="ask-ai-example" onclick="setAskQuestion('When am I most active during the week?')">Most active day?</span>
                        <span class="ask-ai-example" onclick="setAskQuestion('What is my HRV trend telling me?')">HRV analysis</span>
                    </div>
                    <div class="ask-ai-response" id="askAiResponse">
                        <div class="ask-ai-response-text" id="askAiResponseText"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 4: Goals Summary (Compact) -->
        <div id="goalsSection" style="display: none;">
            <div class="coach-section-title" style="margin-top: 32px;">Goals Progress</div>
            <section class="goals-summary" id="goalsSummary">
            <div class="goals-summary-header">
                <div class="goals-summary-title">Today's Goals</div>
                <div class="goals-summary-score">
                    <div class="goals-summary-dots" id="goalsDots"></div>
                    <span class="goals-summary-text" id="goalsText">-- achieved</span>
                </div>
            </div>
            <div class="goals-categories" id="goalsCategories"></div>
            <!-- Goal Suggestions -->
            <div class="goal-suggestions" id="goalSuggestions" style="display: none;">
                <div class="goal-suggestions-header">
                    <div class="goal-suggestions-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="16"/>
                            <line x1="8" y1="12" x2="16" y2="12"/>
                        </svg>
                    </div>
                    <div class="goal-suggestions-title">Suggested Goal Adjustments</div>
                </div>
                <div id="goalSuggestionsList">
                    <!-- Suggestions rendered by JS -->
                </div>
            </div>
        </section>
        </div><!-- End goalsSection wrapper -->

        </div><!-- End TAB: COACH -->

        <!-- ==================== TAB: TODAY ==================== -->
        <div class="tab-content active" id="tab-today">

        <!-- Score Hero Section -->
        <section class="score-hero">
            <div class="fitness-score">
                <div class="score-ring">
                    <svg width="140" height="140" viewBox="0 0 140 140">
                        <defs>
                            <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#6366f1"/>
                                <stop offset="100%" stop-color="#10b981"/>
                            </linearGradient>
                        </defs>
                        <circle class="bg" cx="70" cy="70" r="60"/>
                        <circle class="progress" id="scoreProgress" cx="70" cy="70" r="60" stroke-dasharray="377" stroke-dashoffset="377"/>
                    </svg>
                    <div class="score-number" id="fitnessScore">--</div>
                </div>
                <div class="score-label">Fitness Score</div>
                <div class="score-breakdown">
                    <div class="breakdown-item">
                        <div class="breakdown-value" id="sleepScore">--</div>
                        <div class="breakdown-label">Sleep</div>
                    </div>
                    <div class="breakdown-item">
                        <div class="breakdown-value" id="readinessScore">--</div>
                        <div class="breakdown-label">Readiness</div>
                    </div>
                    <div class="breakdown-item">
                        <div class="breakdown-value" id="activityScore">--</div>
                        <div class="breakdown-label">Activity</div>
                    </div>
                </div>
            </div>

            <div class="key-metrics">
                <div class="metric-card" id="stepsCard">
                    <div class="metric-icon steps">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 4v16M7 4v16M19 4v16M4 8h4M4 16h4M16 8h4M16 16h4"/>
                        </svg>
                    </div>
                    <div class="metric-value" id="avgSteps">--</div>
                    <div class="metric-label">Avg Daily Steps</div>
                    <div class="metric-change" id="stepsChange">--</div>
                </div>
                <div class="metric-card" id="hrvCard">
                    <div class="metric-icon" style="background: rgba(16, 185, 129, 0.15);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                        </svg>
                    </div>
                    <div class="metric-value" id="hrvValue">-- ms</div>
                    <div class="metric-label">HRV</div>
                    <div class="metric-change positive" id="hrvBaseline">Baseline: --</div>
                    <div class="metric-status normal" id="hrvStatus">--</div>
                </div>
                <div class="metric-card" id="sleepCard">
                    <div class="metric-icon" style="background: rgba(139, 92, 246, 0.15);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                    <div class="metric-value" id="sleepScoreValue">--</div>
                    <div class="metric-label">Sleep Score</div>
                    <div class="metric-change positive" id="sleepTrend">--</div>
                </div>
                <div class="metric-card" id="deepSleepCard">
                    <div class="metric-icon" style="background: rgba(139, 92, 246, 0.15);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2">
                            <rect x="3" y="11" width="18" height="10" rx="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                    </div>
                    <div class="metric-value" id="deepSleepValue">-- min</div>
                    <div class="metric-label">Deep Sleep</div>
                    <div class="metric-change positive" id="deepSleepAvg">Avg: --</div>
                </div>
            </div>
        </section>

        <!-- Alerts -->
        <section class="alerts-section">
            <div class="section-header">
                <h2 class="section-title">Health Alerts</h2>
            </div>
            <div class="alerts-grid" id="alertsGrid">
                <div class="loading">Loading alerts...</div>
            </div>
        </section>

        <!-- Stress & Recovery Section -->
        <section class="stress-recovery-section">
            <div class="section-header">
                <h2 class="section-title">Stress & Recovery</h2>
            </div>
            <div class="stress-recovery-grid">
                <!-- Stress Score -->
                <div class="metric-card">
                    <div class="metric-icon" style="background: rgba(239, 68, 68, 0.15);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                            <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                    </div>
                    <div class="metric-value" id="stressScore">--</div>
                    <div class="metric-label">Stress Score</div>
                    <div class="metric-change" id="stressLevel">--</div>
                </div>

                <!-- Recovery Time -->
                <div class="metric-card">
                    <div class="metric-icon" style="background: rgba(16, 185, 129, 0.15);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                        </svg>
                    </div>
                    <div class="metric-value" id="recoveryTime">-- min</div>
                    <div class="metric-label">Recovery Time</div>
                    <div class="metric-change positive" id="recoveryStatus">--</div>
                </div>

                <!-- Resilience -->
                <div class="metric-card">
                    <div class="metric-icon" style="background: rgba(99, 102, 241, 0.15);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                    </div>
                    <div class="metric-value" id="resilienceScore">--</div>
                    <div class="metric-label">Resilience</div>
                    <div class="metric-change" id="resilienceLevel">--</div>
                </div>

                <!-- Day Stress -->
                <div class="metric-card">
                    <div class="metric-icon" style="background: rgba(245, 158, 11, 0.15);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                    </div>
                    <div class="metric-value" id="dayStress">-- min</div>
                    <div class="metric-label">High Stress</div>
                    <div class="metric-change" id="dayStressDetail">Today</div>
                </div>
            </div>
        </section>

        <!-- Body Metrics Section -->
        <section class="body-metrics-section">
            <div class="section-header">
                <h2 class="section-title">Body Metrics</h2>
            </div>
            <div class="body-metrics-grid">
                <!-- SpO2 -->
                <div class="metric-card">
                    <div class="metric-icon" style="background: rgba(59, 130, 246, 0.15);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                            <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
                        </svg>
                    </div>
                    <div class="metric-value" id="spo2Value">--%</div>
                    <div class="metric-label">Blood Oxygen</div>
                    <div class="metric-change positive" id="spo2Status">Normal</div>
                </div>

                <!-- Resting HR -->
                <div class="metric-card">
                    <div class="metric-icon" style="background: rgba(239, 68, 68, 0.15);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                        </svg>
                    </div>
                    <div class="metric-value" id="restingHRValue">-- bpm</div>
                    <div class="metric-label">Resting HR</div>
                    <div class="metric-change" id="restingHRTrend">--</div>
                </div>

                <!-- Body Temp -->
                <div class="metric-card">
                    <div class="metric-icon" style="background: rgba(245, 158, 11, 0.15);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                            <path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/>
                        </svg>
                    </div>
                    <div class="metric-value" id="bodyTempValue">--</div>
                    <div class="metric-label">Temp Deviation</div>
                    <div class="metric-change" id="bodyTempDeviation">vs baseline</div>
                </div>

                <!-- Breath Rate -->
                <div class="metric-card">
                    <div class="metric-icon" style="background: rgba(16, 185, 129, 0.15);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                            <path d="M12 22c4.97 0 9-2.69 9-6v-2c0-3.31-4.03-6-9-6s-9 2.69-9 6v2c0 3.31 4.03 6 9 6z"/>
                            <path d="M12 8V2"/>
                            <path d="M8 4l4-2 4 2"/>
                        </svg>
                    </div>
                    <div class="metric-value" id="breathRateValue">--/min</div>
                    <div class="metric-label">Breath Rate</div>
                    <div class="metric-change positive" id="breathRateStatus">Normal</div>
                </div>
            </div>
        </section>

        </div><!-- End TAB: TODAY -->

        <!-- ==================== TAB: LIFESTYLE ==================== -->
        <div class="tab-content" id="tab-lifestyle">

        <!-- Nutrition Tracking -->
        <section class="nutrition-section" id="nutritionSection">
            <div class="section-header">
                <h2 class="section-title">Nutrition</h2>
            </div>
            <div class="nutrition-grid">
                <!-- Water Tracker -->
                <div class="nutrition-card water-card">
                    <div class="nutrition-card-header">
                        <div class="nutrition-icon water">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
                            </svg>
                        </div>
                        <div class="nutrition-card-title">Water</div>
                        <div class="nutrition-percentage" id="waterPercentage">0%</div>
                    </div>
                    <div class="water-progress-container">
                        <div class="water-count" id="waterCount">0</div>
                        <div class="water-goal">/ <span id="waterGoal">8</span> glasses</div>
                    </div>
                    <div class="water-progress-bar">
                        <div class="water-progress-fill" id="waterProgressFill" style="width: 0%"></div>
                    </div>
                    <div class="water-remaining" id="waterRemaining">8 glasses to go</div>
                    <div class="water-buttons">
                        <button class="water-btn minus" id="waterMinus" title="Remove 1 glass">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                        </button>
                        <button class="water-btn plus" id="waterPlus1" title="Add 1 glass">+1</button>
                        <button class="water-btn plus" id="waterPlus2" title="Add 2 glasses">+2</button>
                    </div>
                </div>

                <!-- Protein Tracker -->
                <div class="nutrition-card protein-card">
                    <div class="nutrition-card-header">
                        <div class="nutrition-icon protein">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                            </svg>
                        </div>
                        <div class="nutrition-card-title">Protein</div>
                        <div class="protein-estimate" id="proteinEstimate">--</div>
                    </div>
                    <div class="protein-label">How was your protein intake today?</div>
                    <div class="protein-buttons">
                        <button class="protein-btn" data-rating="low" id="proteinLow">
                            <span class="protein-level">Low</span>
                            <span class="protein-range">&lt;100g</span>
                        </button>
                        <button class="protein-btn" data-rating="medium" id="proteinMedium">
                            <span class="protein-level">Medium</span>
                            <span class="protein-range">100-140g</span>
                        </button>
                        <button class="protein-btn" data-rating="high" id="proteinHigh">
                            <span class="protein-level">High</span>
                            <span class="protein-range">140g+</span>
                        </button>
                    </div>
                </div>

                <!-- Food Quality -->
                <div class="nutrition-card quality-card">
                    <div class="nutrition-card-header">
                        <div class="nutrition-icon quality">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                                <path d="M2 17l10 5 10-5"/>
                                <path d="M2 12l10 5 10-5"/>
                            </svg>
                        </div>
                        <div class="nutrition-card-title">Food Quality</div>
                        <div class="quality-score" id="qualityScore">--</div>
                    </div>
                    <div class="quality-label">How clean was your eating today?</div>
                    <div class="quality-buttons">
                        <button class="quality-btn" data-quality="1" title="Mostly processed/junk">1</button>
                        <button class="quality-btn" data-quality="2" title="More processed than whole">2</button>
                        <button class="quality-btn" data-quality="3" title="Balanced mix">3</button>
                        <button class="quality-btn" data-quality="4" title="Mostly whole foods">4</button>
                        <button class="quality-btn" data-quality="5" title="All whole foods">5</button>
                    </div>
                    <div class="quality-description" id="qualityDescription">Rate your food choices</div>
                </div>

                <!-- Meal Logger -->
                <div class="nutrition-card meal-card">
                    <div class="nutrition-card-header">
                        <div class="nutrition-icon meal">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <path d="M18 8h1a4 4 0 0 1 0 8h-1"/>
                                <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                                <line x1="6" y1="1" x2="6" y2="4"/>
                                <line x1="10" y1="1" x2="10" y2="4"/>
                                <line x1="14" y1="1" x2="14" y2="4"/>
                            </svg>
                        </div>
                        <div class="nutrition-card-title">Log Meal</div>
                    </div>
                    <div class="meal-count" id="mealCount">0 meals logged today</div>
                    <button class="meal-log-btn" id="logMealBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                        <span>Add Photo or Description</span>
                    </button>
                    <div class="meals-list" id="mealsList"></div>
                </div>
            </div>
        </section>

        </div><!-- End TAB: LIFESTYLE -->

        <!-- ==================== TAB: SLEEP ==================== -->
        <div class="tab-content" id="tab-sleep">

        <!-- Sleep Overview Section -->
        <section class="sleep-overview">
            <div class="section-header">
                <h2 class="section-title">Sleep Analysis</h2>
            </div>

            <!-- Sleep Metrics Grid -->
            <div class="key-metrics" style="margin-bottom: 24px;">
                <div class="metric-card">
                    <div class="metric-icon" style="background: rgba(139, 92, 246, 0.15);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                    <div class="metric-value" id="sleepTabScore">--</div>
                    <div class="metric-label">Sleep Score</div>
                    <div class="metric-change positive" id="sleepTabTrend">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon" style="background: rgba(16, 185, 129, 0.15);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                        </svg>
                    </div>
                    <div class="metric-value" id="sleepTabHrv">-- ms</div>
                    <div class="metric-label">HRV</div>
                    <div class="metric-change positive" id="sleepTabHrvBaseline">Baseline: --</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon" style="background: rgba(139, 92, 246, 0.15);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2">
                            <rect x="3" y="11" width="18" height="10" rx="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                    </div>
                    <div class="metric-value" id="sleepTabDeep">-- min</div>
                    <div class="metric-label">Deep Sleep</div>
                    <div class="metric-change" id="sleepTabDeepAvg">Avg: --</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon" style="background: rgba(99, 102, 241, 0.15);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                    </div>
                    <div class="metric-value" id="sleepTabRem">-- min</div>
                    <div class="metric-label">REM Sleep</div>
                    <div class="metric-change" id="sleepTabRemAvg">Avg: --</div>
                </div>
            </div>

            <!-- Sleep Charts -->
            <div class="charts-grid" style="margin-bottom: 24px;">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Sleep Stages</div>
                        <div class="chart-period">Last night breakdown</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="sleepStagesChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Sleep Efficiency</div>
                        <div class="chart-period">7-day trend</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="sleepEfficiencyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- HRV Trend Chart -->
            <div class="chart-card" style="margin-bottom: 24px;">
                <div class="chart-header">
                    <div class="chart-title">HRV Trend</div>
                    <div class="chart-period">Last 7 nights</div>
                </div>
                <div class="chart-container">
                    <canvas id="hrvTrendChart"></canvas>
                </div>
            </div>

            <!-- Last Night Summary -->
            <div class="coach-card" style="margin-bottom: 24px;">
                <div class="coach-card-title">Last Night Summary</div>
                <div class="summary-grid" id="sleepTabLastNight">
                    <div>
                        <div class="summary-item">
                            <span class="summary-label">Total Sleep</span>
                            <span class="summary-value" id="sleepTabTotal">-- hrs</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Efficiency</span>
                            <span class="summary-value" id="sleepTabEfficiency">--%</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Breath Rate</span>
                            <span class="summary-value" id="sleepTabBreath">--/min</span>
                        </div>
                    </div>
                    <div>
                        <div class="summary-item">
                            <span class="summary-label">Bedtime</span>
                            <span class="summary-value" id="sleepTabBedtime">--:--</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Wake Time</span>
                            <span class="summary-value" id="sleepTabWake">--:--</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Restfulness</span>
                            <span class="summary-value" id="sleepTabRestful">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        </div><!-- End TAB: SLEEP -->

        <!-- ==================== TAB: ACTIVITY ==================== -->
        <div class="tab-content" id="tab-activity">

        <!-- Activity Metrics -->
        <section class="key-metrics" style="margin-bottom: 24px;">
            <div class="metric-card">
                <div class="metric-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                </div>
                <div class="metric-content">
                    <div class="metric-label">Avg Heart Rate</div>
                    <div class="metric-value" id="activityAvgHr">-- bpm</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                </div>
                <div class="metric-content">
                    <div class="metric-label">Active Days</div>
                    <div class="metric-value" id="activityActiveDays">--</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="5" r="3"/>
                        <line x1="12" y1="22" x2="12" y2="8"/>
                        <path d="M5 12H2a10 10 0 0 0 20 0h-3"/>
                    </svg>
                </div>
                <div class="metric-content">
                    <div class="metric-label">Workouts (30d)</div>
                    <div class="metric-value" id="activityWorkouts">--</div>
                </div>
            </div>
        </section>

        <!-- Charts -->
        <section class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Daily Steps</div>
                    <div class="chart-period">Last 7 days</div>
                </div>
                <div class="chart-container">
                    <canvas id="stepsChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Workouts</div>
                    <div class="chart-period">By type</div>
                </div>
                <div class="chart-container">
                    <canvas id="workoutChart"></canvas>
                </div>
            </div>
        </section>

        <section class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Heart Rate Trends</div>
                    <div class="chart-period">Last 7 days</div>
                </div>
                <div class="chart-container">
                    <canvas id="heartChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Weekly Comparison</div>
                    <div class="chart-period">Steps by week</div>
                </div>
                <div class="chart-container">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>
        </section>

        </div><!-- End TAB: ACTIVITY -->

        <!-- ==================== TAB: TRENDS ==================== -->
        <div class="tab-content" id="tab-trends">

        <!-- Stats Grid -->
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-header-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                    </span>
                    <span class="stat-header-title">Weekly Heatmap</span>
                </div>
                <div class="heatmap-grid" id="heatmapGrid"></div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-header-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                    </span>
                    <span class="stat-header-title">Streaks</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Current Streak</span>
                    <span class="stat-value" id="currentStreak">-- days</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Longest Streak</span>
                    <span class="stat-value" id="longestStreak">-- days</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Best Day</span>
                    <span class="stat-value" id="bestDay">--</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-header-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="20" x2="12" y2="10"/>
                            <line x1="18" y1="20" x2="18" y2="4"/>
                            <line x1="6" y1="20" x2="6" y2="16"/>
                        </svg>
                    </span>
                    <span class="stat-header-title">30-Day Totals</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Steps</span>
                    <span class="stat-value" id="totalSteps">--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Calories</span>
                    <span class="stat-value" id="totalCalories">--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Days Tracked</span>
                    <span class="stat-value" id="daysTracked">--</span>
                </div>
            </div>
        </section>

        <!-- Long-term Trends Section -->
        <section class="trends-section" id="trendsSection">
            <div class="section-header">
                <h2 class="section-title">Trends & Progress</h2>
                <div class="time-range-selector" id="timeRangeSelector">
                    <button class="range-btn active" data-range="7d">7D</button>
                    <button class="range-btn" data-range="30d">30D</button>
                    <button class="range-btn" data-range="90d">90D</button>
                </div>
            </div>

            <!-- Period Comparison -->
            <div class="comparison-grid">
                <div class="comparison-card">
                    <div class="comparison-header">
                        <span class="comparison-period" id="currentPeriodLabel">This Week</span>
                        <span class="vs-label">vs</span>
                        <span class="comparison-period" id="previousPeriodLabel">Last Week</span>
                    </div>
                    <div class="comparison-metrics" id="comparisonMetrics">
                        <div class="comparison-item">
                            <span class="comparison-label">Avg Steps</span>
                            <div class="comparison-values">
                                <span class="current-value" id="compStepsCurrent">--</span>
                                <span class="comparison-delta positive" id="compStepsDelta">--</span>
                                <span class="previous-value" id="compStepsPrevious">--</span>
                            </div>
                        </div>
                        <div class="comparison-item">
                            <span class="comparison-label">Avg Sleep</span>
                            <div class="comparison-values">
                                <span class="current-value" id="compSleepCurrent">--</span>
                                <span class="comparison-delta positive" id="compSleepDelta">--</span>
                                <span class="previous-value" id="compSleepPrevious">--</span>
                            </div>
                        </div>
                        <div class="comparison-item">
                            <span class="comparison-label">Avg HRV</span>
                            <div class="comparison-values">
                                <span class="current-value" id="compHrvCurrent">--</span>
                                <span class="comparison-delta positive" id="compHrvDelta">--</span>
                                <span class="previous-value" id="compHrvPrevious">--</span>
                            </div>
                        </div>
                        <div class="comparison-item">
                            <span class="comparison-label">Workouts</span>
                            <div class="comparison-values">
                                <span class="current-value" id="compWorkoutsCurrent">--</span>
                                <span class="comparison-delta positive" id="compWorkoutsDelta">--</span>
                                <span class="previous-value" id="compWorkoutsPrevious">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Personal Records Section -->
        <section class="records-section" id="recordsSection">
            <div class="section-header">
                <h2 class="section-title">Personal Records</h2>
            </div>
            <div class="records-grid" id="recordsGrid">
                <!-- Records will be populated by JS -->
            </div>
        </section>

        <!-- Milestones Section -->
        <section class="milestones-section" id="milestonesSection">
            <div class="section-header">
                <h2 class="section-title">Milestones</h2>
                <button class="btn-text" id="exportDataBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export Data
                </button>
            </div>
            <div class="milestones-grid" id="milestonesGrid">
                <!-- Milestones will be populated by JS -->
            </div>
        </section>

        </div><!-- End TAB: TRENDS -->

        </div><!-- End legacyTabs -->

    </div><!-- End container -->

    <!-- Goals Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="modal-close" onclick="closeSettingsModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Personalization Section -->
                <div class="settings-section" style="margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
                    <div class="settings-section-title" style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">Personalization</div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <label style="font-size: 13px; color: var(--text-secondary); min-width: 80px;">Your Name</label>
                        <input type="text" id="userNameInput" placeholder="Enter your name"
                            style="flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-elevated); color: var(--text-primary); font-size: 14px;">
                    </div>
                </div>
                <!-- Goals Section -->
                <div class="settings-section-title" style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">Goal Settings</div>
                <div id="settingsForm"></div>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-left">
                    <button class="btn btn-danger" onclick="resetGoals()">Reset Defaults</button>
                </div>
                <div class="modal-footer-right">
                    <button class="btn btn-secondary" onclick="closeSettingsModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveGoals()">Save Goals</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Journal FAB Button - scrolls to Smart Health Journal -->
    <button class="checkin-fab not-checked-in" id="checkinFab" onclick="scrollToJournal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"/>
        </svg>
    </button>

    <!-- Include Goals Manager -->
    <script src="goals-manager.js"></script>
    <!-- Include Recommendation Engine -->
    <script src="recommendation-engine.js"></script>
    <!-- Include Check-in Manager -->
    <script src="checkin-manager.js"></script>
    <!-- Include Nutrition Manager -->
    <script src="nutrition-manager.js"></script>
    <!-- Include Lifestyle Manager (Smart Health Journal) -->
    <script src="lifestyle-manager.js"></script>
    <!-- Include Analytics Engine -->
    <script src="analytics-engine.js"></script>
    <!-- Include AI Insights Engine -->
    <script src="insights-engine.js"></script>
    <!-- Include AI Coach -->
    <script src="ai-coach.js"></script>

    <script>
        // API Key for AI Coach (loaded from Vercel environment variable)
        let claudeApiKey = null;

        // Fetch API key from Vercel serverless function
        async function loadApiKey() {
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    const config = await response.json();
                    claudeApiKey = config.apiKey;
                    console.log('API key loaded from server');
                }
            } catch (e) {
                // Fallback to localStorage for local development
                claudeApiKey = localStorage.getItem('claude_api_key');
                console.log('Using localStorage API key');
            }
        }

        let data = null;
        let chartsInitialized = false;
        let sleepChartsInitialized = false;
        let trendSparklineChart = null;
        let currentTrendType = 'sleep';

        // ===== Score Status Helper =====
        function getScoreStatus(score) {
            if (score >= 85) return { text: 'Excellent', class: 'excellent' };
            if (score >= 70) return { text: 'Good', class: 'good' };
            if (score >= 50) return { text: 'Fair', class: 'fair' };
            return { text: 'Low', class: 'low' };
        }

        // ===== Render Today's Scores Hero =====
        function renderScoresHero() {
            if (!data) return;

            const todayScores = data.todayScores || {};
            const metrics = data.metrics || {};

            // Sleep Score
            const sleepScore = todayScores.sleep || metrics.sleepScore || '--';
            const sleepStatus = getScoreStatus(sleepScore);
            document.getElementById('todaySleepScore').textContent = sleepScore;
            const sleepStatusEl = document.getElementById('sleepStatus');
            sleepStatusEl.className = `score-card-status ${sleepStatus.class}`;
            document.getElementById('sleepStatusText').textContent = sleepStatus.text;
            document.getElementById('sleepAvgText').textContent = `7-day avg: ${metrics.sleepScore || '--'}`;
            const deepSleep = data.sleepStages?.lastNight?.deep || '--';
            document.getElementById('sleepSecondary').textContent = `Deep: ${deepSleep} min`;

            // Readiness Score
            const readinessScore = todayScores.readiness || data.readinessBreakdown?.score || metrics.readinessScore || '--';
            const readinessStatus = getScoreStatus(readinessScore);
            document.getElementById('todayReadinessScore').textContent = readinessScore;
            const readinessStatusEl = document.getElementById('readinessStatus');
            readinessStatusEl.className = `score-card-status ${readinessStatus.class}`;
            document.getElementById('readinessStatusText').textContent = readinessStatus.text;
            document.getElementById('readinessAvgText').textContent = `7-day avg: ${metrics.readinessScore || '--'}`;
            const hrv = data.hrv?.current || '--';
            document.getElementById('readinessSecondary').textContent = `HRV: ${hrv} ms`;

            // Activity Score
            const activityScore = todayScores.activity || metrics.activityScore || '--';
            const activityStatus = getScoreStatus(activityScore);
            document.getElementById('todayActivityScore').textContent = activityScore;
            const activityStatusEl = document.getElementById('activityStatus');
            activityStatusEl.className = `score-card-status ${activityStatus.class}`;
            document.getElementById('activityStatusText').textContent = activityStatus.text;
            document.getElementById('activityAvgText').textContent = `7-day avg: ${metrics.activityScore || '--'}`;
            const todaySteps = data.today?.steps || 0;
            document.getElementById('activitySecondary').textContent = `Steps: ${todaySteps.toLocaleString()}`;
        }

        // ===== Render Quick Stats =====
        function renderQuickStats() {
            if (!data) return;

            // HRV
            document.getElementById('qsHrv').textContent = `${data.hrv?.current || '--'} ms`;

            // Deep Sleep
            const deepSleep = data.sleepStages?.lastNight?.deep || data.sleepStages?.avgDeep || '--';
            document.getElementById('qsDeep').textContent = `${deepSleep} min`;

            // Resting HR
            document.getElementById('qsRhr').textContent = `${data.metrics?.restingHR || '--'} bpm`;

            // Today's Steps
            document.getElementById('qsSteps').textContent = (data.today?.steps || 0).toLocaleString();
        }

        // ===== Render Today's Insight with AI Coach =====
        async function renderHeroInsight() {
            if (!data) return;

            const headlineEl = document.getElementById('heroInsightText');
            const recommendationEl = document.getElementById('heroRecommendation');
            const patternEl = document.getElementById('heroPattern');

            // Show loading state
            headlineEl.textContent = 'AI Coach is analyzing your data...';
            recommendationEl.textContent = '';
            patternEl.textContent = '';

            try {
                // Use AI Coach with API key (from Vercel env or localStorage fallback)
                if (typeof AICoach !== 'undefined') {
                    const insight = await AICoach.getDailyInsight(data, claudeApiKey);

                    headlineEl.textContent = insight.headline || 'Analyzing your data...';

                    if (insight.recommendation) {
                        recommendationEl.textContent = ' ' + insight.recommendation;
                    }

                    if (insight.pattern) {
                        patternEl.textContent = insight.pattern;
                    }
                } else {
                    // Fallback if AICoach not loaded
                    headlineEl.textContent = 'AI Coach loading...';
                }
            } catch (error) {
                console.error('AI Coach error:', error);
                // Fallback to simple insight
                const readiness = data.todayScores?.readiness || data.metrics?.readinessScore || 0;
                const sleep = data.todayScores?.sleep || data.metrics?.sleepScore || 0;
                headlineEl.textContent = `Readiness: ${readiness}, Sleep: ${sleep} - ${readiness >= 70 ? 'Good day for activity' : 'Focus on recovery'}`;
            }
        }

        // Refresh AI Insight on demand
        async function refreshAIInsight() {
            const refreshBtn = document.querySelector('.insight-refresh-btn');
            if (refreshBtn) {
                refreshBtn.classList.add('loading');
            }

            // Clear cache to force new insight
            if (typeof AICoach !== 'undefined') {
                AICoach.cache = {};
            }

            await renderHeroInsight();

            if (refreshBtn) {
                refreshBtn.classList.remove('loading');
            }
        }

        // ===== Ask AI Question Feature =====
        function askSuggestion(element) {
            const input = document.getElementById('askAiInput');
            input.value = element.textContent;
            askAIQuestion();
        }

        async function askAIQuestion() {
            const input = document.getElementById('askAiInput');
            const btn = document.getElementById('askAiBtn');
            const responseDiv = document.getElementById('askAiResponse');
            const responseText = document.getElementById('askAiResponseText');

            const question = input.value.trim();
            if (!question) {
                input.focus();
                return;
            }

            // Check for API key (from Vercel env or localStorage)
            if (!claudeApiKey) {
                responseDiv.classList.add('visible');
                responseText.innerHTML = '<span style="color: var(--text-muted);">API key not configured. Please contact the administrator.</span>';
                return;
            }

            // Show loading state
            btn.disabled = true;
            btn.classList.add('loading');
            responseDiv.classList.add('visible');
            responseText.innerHTML = '<span style="color: var(--text-muted);">Thinking...</span>';

            try {
                const answer = await getAIAnswer(question, claudeApiKey);
                responseText.innerHTML = answer;
                input.value = ''; // Clear input after successful answer
            } catch (error) {
                console.error('Ask AI error:', error);
                responseText.innerHTML = '<span style="color: #ef4444;">Sorry, there was an error getting a response. Please try again.</span>';
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
            }
        }

        async function getAIAnswer(question, apiKey) {
            if (!data) {
                return 'No health data available. Please load your Oura data first.';
            }

            // Build comprehensive health context
            const todayScores = data.todayScores || {};
            const metrics = data.metrics || {};
            const sleepStages = data.sleepStages || {};
            const hrvData = data.hrv || {};
            const stressData = data.stress || {};
            const readiness = data.readinessBreakdown || {};

            const healthContext = `
CURRENT HEALTH DATA:

TODAY'S SCORES:
- Sleep Score: ${todayScores.sleep || 'N/A'}
- Readiness Score: ${todayScores.readiness || 'N/A'}
- Activity Score: ${todayScores.activity || 'N/A'}

7-DAY AVERAGES:
- Avg Sleep Score: ${metrics.sleepScore || 'N/A'}
- Avg Readiness Score: ${metrics.readinessScore || 'N/A'}
- Avg Activity Score: ${metrics.activityScore || 'N/A'}

SLEEP DATA (Last Night):
- Deep Sleep: ${sleepStages.lastNight?.deep || 'N/A'} minutes (30-day avg: ${sleepStages.avgDeep || 'N/A'} min)
- REM Sleep: ${sleepStages.lastNight?.rem || 'N/A'} minutes (30-day avg: ${sleepStages.avgRem || 'N/A'} min)
- Light Sleep: ${sleepStages.lastNight?.light || 'N/A'} minutes
- Sleep Efficiency: ${sleepStages.lastNight?.efficiency || 'N/A'}% (30-day avg: ${sleepStages.avgEfficiency || 'N/A'}%)
- Total Sleep: ${sleepStages.lastNight?.total || 'N/A'} minutes
- Sleep Latency: ${sleepStages.lastNight?.latency || 'N/A'} minutes

HRV (Heart Rate Variability):
- Current HRV: ${hrvData.current || 'N/A'} ms
- 7-Day Avg HRV: ${hrvData.avg7Days || 'N/A'} ms
- Baseline (30-day): ${hrvData.baseline || 'N/A'} ms
- HRV Status: ${hrvData.status || 'N/A'}
- HRV Trend (7 days): ${hrvData.trend7Days?.join(', ') || 'N/A'}

RECOVERY INDICATORS:
- Resting HR: ${metrics.restingHR || 'N/A'} bpm
- Recovery Index Score: ${readiness.recoveryIndex || 'N/A'}
- Body Temperature Deviation: ${readiness.tempDeviation || 0}C
- HRV Balance Score: ${readiness.hrvBalance || 'N/A'}
- Previous Night Score: ${readiness.previousNight || 'N/A'}
- Activity Balance Score: ${readiness.activityBalance || 'N/A'}
- Sleep Balance Score: ${readiness.sleepBalance || 'N/A'}

ACTIVITY DATA:
- Today's Steps: ${data.today?.steps?.toLocaleString() || 'N/A'}
- 7-Day Avg Steps: ${metrics.dailyAvgSteps?.toLocaleString() || 'N/A'}
- Current Streak: ${metrics.currentStreak || 0} days (10k+ steps)
- Workouts This Month: ${metrics.totalWorkouts || 0}
- Active Days (last 7): ${metrics.activeDays || 0}
- Consistency (% hitting 10k): ${metrics.consistency || 0}%

STRESS DATA:
- Today's High Stress: ${stressData.today?.stressMinutes || 'N/A'} minutes
- Today's Recovery Time: ${stressData.today?.recoveryMinutes || 'N/A'} minutes
- Avg Stress (7-day): ${stressData.avgStressMinutes || 'N/A'} min/day
- Avg Recovery (7-day): ${stressData.avgRecoveryMinutes || 'N/A'} min/day

SpO2: ${data.spo2?.current || 'N/A'}%
Breath Rate: ${sleepStages.avgBreathRate || 'N/A'} breaths/min
`;

            // Add lifestyle context if available
            let lifestyleContext = '';
            if (typeof LifestyleManager !== 'undefined') {
                const lifestyle = LifestyleManager.getLifestyleContext();
                if (lifestyle) {
                    lifestyleContext = '\nLIFESTYLE FACTORS (User-reported):';
                    if (lifestyle.lastNight) {
                        const ln = lifestyle.lastNight;
                        lifestyleContext += '\nLast Night:';
                        if (ln.caffeine) lifestyleContext += `\n- Caffeine: ${ln.caffeine.replace(/_/g, ' ')}`;
                        if (ln.alcohol) lifestyleContext += `\n- Alcohol: ${ln.alcohol.replace(/_/g, ' ')}`;
                        if (ln.lastMealTime) lifestyleContext += `\n- Last meal: ${ln.lastMealTime.replace(/_/g, ' ')} before bed`;
                        if (ln.screenTime) lifestyleContext += `\n- Screen time: ${ln.screenTime.replace(/_/g, ' ')}`;
                        if (ln.stress) lifestyleContext += `\n- Stress level: ${ln.stress}/5`;
                    }
                    if (lifestyle.thisMorning) {
                        const tm = lifestyle.thisMorning;
                        lifestyleContext += '\nThis Morning:';
                        if (tm.energy) lifestyleContext += `\n- Subjective energy: ${tm.energy}/5`;
                        if (tm.sleepFelt) lifestyleContext += `\n- Sleep felt: ${tm.sleepFelt}`;
                    }
                    if (lifestyle.patterns && lifestyle.patterns.length > 0) {
                        lifestyleContext += '\nDiscovered Personal Patterns:';
                        lifestyle.patterns.forEach(p => {
                            lifestyleContext += `\n- ${p.insight}`;
                        });
                    }
                }
            }

            const systemPrompt = `You are a knowledgeable health coach analyzing Oura Ring data and lifestyle factors. You have access to the user's complete health metrics.

Guidelines:
- Be specific and reference actual numbers from their data
- Provide actionable, science-backed recommendations
- Be encouraging but honest about areas for improvement
- Keep responses concise (2-4 paragraphs max)
- If data is missing (N/A), acknowledge it and work with what's available
- Focus on patterns and correlations in the data
- Connect lifestyle factors (caffeine, alcohol, meal timing, stress) to health outcomes when relevant
- Mention specific improvements they could make today

${healthContext}${lifestyleContext}`;

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-3-5-haiku-20241022',
                    max_tokens: 600,
                    system: systemPrompt,
                    messages: [{
                        role: 'user',
                        content: question
                    }]
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
            }

            const result = await response.json();
            const answer = result.content[0].text;

            // Format the response with better styling
            return answer
                .replace(/\n\n/g, '</p><p style="margin-top: 12px;">')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^(.*)$/, '<p>$1</p>');
        }

        // ===== Render Collapsible Alerts =====
        function renderCollapsibleAlerts() {
            if (!data) return;

            const alerts = data.alerts || [];
            const warningCount = alerts.filter(a => a.type === 'warning').length;

            // Update badge and header
            const badge = document.getElementById('alertsBadge');
            const header = document.getElementById('alertsHeader');
            const title = document.getElementById('alertsTitle');

            if (warningCount > 0) {
                badge.textContent = warningCount;
                badge.className = 'alerts-badge warning';
                header.classList.add('has-warnings');
                title.textContent = `${warningCount} Health Alert${warningCount > 1 ? 's' : ''}`;
            } else {
                badge.textContent = '';
                badge.className = 'alerts-badge success';
                header.classList.remove('has-warnings');
                title.textContent = 'All Good';
            }

            // Render alerts content
            const container = document.getElementById('alertsGrid');
            if (alerts.length === 0 || (alerts.length === 1 && alerts[0].type === 'success')) {
                container.innerHTML = '<div class="alert-card success"><div class="alert-icon"></div><div><div class="alert-title">All Good</div><div class="alert-message">No health concerns detected</div></div></div>';
            } else {
                container.innerHTML = alerts.map(alert => `
                    <div class="alert-card ${alert.type}">
                        <div class="alert-icon">${alert.type === 'warning' ? '' : ''}</div>
                        <div>
                            <div class="alert-title">${alert.title}</div>
                            <div class="alert-message">${alert.message}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // ===== Toggle Functions =====
        function toggleAlerts() {
            const header = document.getElementById('alertsHeader');
            const content = document.getElementById('alertsContent');
            header.classList.toggle('expanded');
            content.classList.toggle('visible');
        }

        function toggleDetails(sectionId) {
            const section = document.getElementById(sectionId);
            const header = section.querySelector('.details-header');
            const content = section.querySelector('.details-content');
            header.classList.toggle('expanded');
            content.classList.toggle('visible');

            // Initialize content when first opened
            if (content.classList.contains('visible')) {
                if (sectionId === 'sleepDetails' && !sleepChartsInitialized) {
                    initSleepCharts();
                    renderSleepTab();
                }
                if (sectionId === 'activityDetails' && !chartsInitialized) {
                    initCharts();
                    renderHeatmap();
                }
                if (sectionId === 'nutritionDetails') {
                    renderNutritionDetails();
                }
            }
        }

        function renderNutritionDetails() {
            // Clone nutrition content from hidden legacy section
            const sourceGrid = document.querySelector('#tab-lifestyle .nutrition-grid');
            const targetGrid = document.getElementById('nutritionGridInline');
            if (sourceGrid && targetGrid && targetGrid.innerHTML === '') {
                targetGrid.innerHTML = sourceGrid.innerHTML;
                // Re-initialize nutrition UI for the cloned elements
                initNutritionUI();
            }

            const sourceCheckin = document.querySelector('#tab-lifestyle .checkin-inline-grid');
            const targetCheckin = document.getElementById('checkinGridInline');
            if (sourceCheckin && targetCheckin && targetCheckin.innerHTML === '') {
                targetCheckin.innerHTML = sourceCheckin.innerHTML;
            }
        }

        // ===== 7-Day Trend Sparkline =====
        function switchTrend(type) {
            currentTrendType = type;

            // Update toggle buttons
            document.querySelectorAll('.trend-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.trend === type);
            });

            renderTrendSparkline();
        }

        function renderTrendSparkline() {
            if (!data) return;

            const canvas = document.getElementById('trendSparkline');
            if (!canvas) return;

            let labels, values, color, label;

            switch (currentTrendType) {
                case 'sleep':
                    labels = data.sleepStages?.last7Days?.map(d => {
                        const date = new Date(d.day + 'T12:00:00');
                        return date.toLocaleDateString('en-US', { weekday: 'short' });
                    }) || data.last7Days?.labels || [];
                    values = data.sleepStages?.last7Days?.map(d => d.efficiency) || [];
                    color = '#8b5cf6';
                    label = 'Sleep Efficiency %';
                    break;
                case 'steps':
                    labels = data.last7Days?.labels || [];
                    values = data.last7Days?.values || [];
                    color = '#6366f1';
                    label = 'Steps';
                    break;
                case 'hrv':
                    labels = data.last7Days?.labels || [];
                    values = data.hrv?.trend7Days || [];
                    color = '#10b981';
                    label = 'HRV (ms)';
                    break;
            }

            // Destroy existing chart
            if (trendSparklineChart) {
                trendSparklineChart.destroy();
            }

            trendSparklineChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: labels.slice(-7),
                    datasets: [{
                        data: values.slice(-7),
                        borderColor: color,
                        backgroundColor: color + '20',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: color
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: currentTrendType === 'steps',
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: {
                                color: '#6b7280',
                                font: { size: 11 },
                                callback: v => currentTrendType === 'steps' ? (v/1000).toFixed(0) + 'k' : v
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#6b7280', font: { size: 11 } }
                        }
                    }
                }
            });
        }

        // ===== Legacy Tab Navigation (kept for compatibility) =====
        let currentTab = localStorage.getItem('healthDashboardTab') || 'today';

        function switchTab(tabId) {
            // Update URL hash
            window.location.hash = tabId;

            // Store in localStorage
            localStorage.setItem('healthDashboardTab', tabId);
            currentTab = tabId;

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabId);
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `tab-${tabId}`);
            });

            // Initialize charts lazily when their tab is shown
            if (tabId === 'activity' && !chartsInitialized && data) {
                initCharts();
            }
            if (tabId === 'sleep' && !sleepChartsInitialized && data) {
                initSleepCharts();
                renderSleepTab();
            }
            if (tabId === 'trends' && data) {
                // Refresh trends data when tab is shown
                renderComparison();
                renderPersonalRecords();
                renderMilestones();
            }
            if (tabId === 'lifestyle' && data) {
                renderLifestyleTab();
            }
        }

        // Initialize tab from URL hash or localStorage
        function initTabs() {
            const hash = window.location.hash.slice(1);
            const validTabs = ['today', 'sleep', 'activity', 'lifestyle', 'trends', 'coach'];

            // Priority: URL hash > localStorage > default 'today'
            if (hash && validTabs.includes(hash)) {
                currentTab = hash;
            } else if (!localStorage.getItem('healthDashboardTab')) {
                // First visit - default to 'today'
                currentTab = 'today';
            }

            switchTab(currentTab);
        }

        // Handle browser back/forward
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.slice(1);
            const validTabs = ['today', 'sleep', 'activity', 'lifestyle', 'trends', 'coach'];
            if (hash && validTabs.includes(hash)) {
                switchTab(hash);
            }
        });

        async function loadData() {
            const paths = ['/data.json', './data.json', 'data.json'];

            for (const path of paths) {
                try {
                    const res = await fetch(path);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    data = await res.json();
                    window.dashboardData = data; // Make available to InsightsEngine
                    console.log('Data loaded:', data);

                    // New single-page layout rendering
                    renderScoresHero();
                    renderQuickStats();
                    renderHeroInsight();
                    renderCollapsibleAlerts();
                    renderTrendSparkline();

                    // Legacy rendering (for hidden sections)
                    renderDashboard();
                    renderGoalsSummary();
                    renderMorningCoach();
                    initCheckinUI();
                    initNutritionUI();
                    await initSmartJournal();
                    initTrendsUI();
                    initAIInsights();
                    applyPersonalization();
                    return;
                } catch (err) {
                    console.warn('Failed to load from', path);
                }
            }

            document.getElementById('lastUpdated').textContent = 'Error loading data';
        }

        // ===== Goals Integration =====

        function getCurrentMetrics() {
            if (!data) return {};
            const m = data.metrics || {};
            return {
                dailySteps: m.dailyAvgSteps || 0,
                weeklyWorkouts: data.thisWeek?.workouts || 0,
                activeDays: m.activeDays || 0,
                readinessScore: m.readinessScore || 0,
                sleepScore: m.sleepScore || 0,
                hrvBaseline: data.hrv?.current || 0,
                deepSleepMinutes: data.sleepStages?.last7Days?.[data.sleepStages?.last7Days?.length - 1]?.deep || 0,
                sleepEfficiency: data.sleepStages?.avgEfficiency || 0,
                remSleepMinutes: data.sleepStages?.last7Days?.[data.sleepStages?.last7Days?.length - 1]?.rem || 0,
                maxStressMinutes: data.stress?.today?.stressMinutes || 0,
                minRecoveryMinutes: data.stress?.today?.recoveryMinutes || 0
            };
        }

        function renderGoalsSummary() {
            if (!data || typeof GoalsManager === 'undefined') return;

            const currentMetrics = getCurrentMetrics();
            const summary = GoalsManager.calculateDailySummary(currentMetrics);

            if (summary.total === 0) {
                document.getElementById('goalsSection').style.display = 'none';
                return;
            }

            document.getElementById('goalsSection').style.display = 'block';

            // Render dots
            const dotsHtml = summary.details.map(d =>
                `<div class="goals-summary-dot ${d.achieved ? 'achieved' : ''}"></div>`
            ).join('');
            document.getElementById('goalsDots').innerHTML = dotsHtml;

            // Summary text
            document.getElementById('goalsText').textContent =
                `${summary.achieved}/${summary.total} achieved`;

            // Render categories
            const categories = GoalsManager.categories;
            let categoriesHtml = '';

            Object.entries(summary.byCategory).forEach(([catKey, catData]) => {
                const cat = categories[catKey] || { label: catKey };
                const categoryGoals = summary.details.filter(d => d.category === catKey);

                const chipsHtml = categoryGoals.map(goal => {
                    const icon = goal.achieved
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>'
                        : '';
                    return `<span class="goal-chip ${goal.achieved ? 'achieved' : 'missed'}">${icon}${goal.label} (${goal.percentage}%)</span>`;
                }).join('');

                categoriesHtml += `
                    <div class="goals-category">
                        <span class="goals-category-label">${cat.label}</span>
                        <div class="goals-category-items">${chipsHtml}</div>
                    </div>
                `;
            });

            document.getElementById('goalsCategories').innerHTML = categoriesHtml;
        }

        function renderMetricProgress(elementId, metric, currentValue) {
            if (typeof GoalsManager === 'undefined') return;

            const progress = GoalsManager.getProgress(metric, currentValue);
            if (!progress) return;

            const container = document.getElementById(elementId);
            if (!container) return;

            // Find or create progress section
            let progressSection = container.querySelector('.metric-progress');
            if (!progressSection) {
                progressSection = document.createElement('div');
                progressSection.className = 'metric-progress';
                container.appendChild(progressSection);
            }

            const pct = Math.min(progress.percentage, 100);
            const colorClass = pct < 50 ? 'low' : pct < 80 ? 'medium' : 'high';

            progressSection.innerHTML = `
                <div class="metric-progress-header">
                    <span class="metric-progress-label">Goal: ${progress.target.toLocaleString()}</span>
                    <span class="metric-progress-value">${progress.percentage}%</span>
                </div>
                <div class="metric-progress-bar">
                    <div class="metric-progress-fill ${colorClass}" style="width: ${pct}%"></div>
                </div>
            `;
        }

        // Settings Modal Functions
        function openSettingsModal() {
            if (typeof GoalsManager === 'undefined') {
                console.error('GoalsManager not loaded');
                return;
            }

            // Load user name into input
            const userName = localStorage.getItem('health_dashboard_user_name') || '';
            document.getElementById('userNameInput').value = userName;

            renderSettingsForm();
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function renderSettingsForm() {
            const byCategory = GoalsManager.getGoalsByCategory();
            let html = '';

            Object.entries(byCategory).forEach(([catKey, category]) => {
                html += `<div class="form-section">
                    <div class="form-section-title">${category.label}</div>`;

                category.goals.forEach(goal => {
                    const hint = getGoalHint(goal.key);
                    html += `
                        <div class="form-row">
                            <div class="form-label">
                                <div class="form-label-text">${goal.label}</div>
                                ${hint ? `<div class="form-label-hint">${hint}</div>` : ''}
                            </div>
                            <div class="form-input-group">
                                <input type="number"
                                    class="form-input"
                                    id="goal-${goal.key}"
                                    value="${goal.target}"
                                    min="0"
                                    ${goal.autoBaseline ? 'data-auto="true"' : ''}>
                                <span class="form-unit">${goal.unit || ''}</span>
                                <label class="form-toggle">
                                    <input type="checkbox"
                                        id="enabled-${goal.key}"
                                        ${goal.enabled ? 'checked' : ''}>
                                    <span class="form-toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            });

            // Add Nutrition Goals section
            if (typeof NutritionManager !== 'undefined') {
                const nutritionGoals = NutritionManager.getGoals();
                html += `
                    <div class="form-section">
                        <div class="form-section-title">Nutrition</div>
                        <div class="form-row">
                            <div class="form-label">
                                <div class="form-label-text">Daily Water Goal</div>
                                <div class="form-label-hint">Glasses per day</div>
                            </div>
                            <div class="form-input-group">
                                <input type="number"
                                    class="form-input"
                                    id="nutrition-waterGlasses"
                                    value="${nutritionGoals.waterGlasses || 8}"
                                    min="1"
                                    max="20">
                                <span class="form-unit">glasses</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-label">
                                <div class="form-label-text">Daily Protein Goal</div>
                                <div class="form-label-hint">Target grams per day</div>
                            </div>
                            <div class="form-input-group">
                                <input type="number"
                                    class="form-input"
                                    id="nutrition-proteinGrams"
                                    value="${nutritionGoals.proteinGrams || 150}"
                                    min="50"
                                    max="300">
                                <span class="form-unit">grams</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('settingsForm').innerHTML = html;
        }

        function getGoalHint(goalKey) {
            if (!data) return '';
            const m = data.metrics || {};

            const hints = {
                dailySteps: `Your avg: ${(m.dailyAvgSteps || 0).toLocaleString()}`,
                hrvBaseline: data.hrv?.baseline ? `Your 30-day avg: ${data.hrv.baseline}ms` : '',
                deepSleepMinutes: data.sleepStages?.avgDeep ? `Your avg: ${data.sleepStages.avgDeep} min` : '',
                sleepEfficiency: data.sleepStages?.avgEfficiency ? `Your avg: ${data.sleepStages.avgEfficiency}%` : '',
                readinessScore: m.readinessScore ? `Recent: ${m.readinessScore}` : '',
                sleepScore: m.sleepScore ? `Recent: ${m.sleepScore}` : ''
            };

            return hints[goalKey] || '';
        }

        function saveGoals() {
            if (typeof GoalsManager === 'undefined') return;

            // Save user name
            const userName = document.getElementById('userNameInput').value.trim();
            localStorage.setItem('health_dashboard_user_name', userName);
            applyPersonalization();

            const { goals } = GoalsManager.load();

            Object.keys(goals).forEach(key => {
                const input = document.getElementById(`goal-${key}`);
                const toggle = document.getElementById(`enabled-${key}`);

                if (input) {
                    goals[key].target = parseInt(input.value, 10) || goals[key].target;
                }
                if (toggle) {
                    goals[key].enabled = toggle.checked;
                }
            });

            GoalsManager.save(goals);

            // Save nutrition goals
            if (typeof NutritionManager !== 'undefined') {
                const waterInput = document.getElementById('nutrition-waterGlasses');
                const proteinInput = document.getElementById('nutrition-proteinGrams');

                if (waterInput || proteinInput) {
                    NutritionManager.updateGoals({
                        waterGlasses: parseInt(waterInput?.value, 10) || 8,
                        proteinGrams: parseInt(proteinInput?.value, 10) || 150
                    });
                }
            }

            closeSettingsModal();
            renderGoalsSummary();
            renderDashboard();
            if (typeof renderNutritionUI === 'function') {
                renderNutritionUI();
            }
        }

        function applyPersonalization() {
            const userName = localStorage.getItem('health_dashboard_user_name') || '';

            // Update header title
            const titleEl = document.getElementById('dashboardTitle');
            if (titleEl) {
                titleEl.textContent = userName ? `${userName}'s Health Dashboard` : 'Health Dashboard';
            }

            // Update Coach greeting
            const greetingEl = document.getElementById('coachGreeting');
            if (greetingEl) {
                const hour = new Date().getHours();
                let greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
                greetingEl.textContent = userName ? `${greeting}, ${userName}` : greeting;
            }
        }

        function resetGoals() {
            if (confirm('Reset all goals to default values?')) {
                GoalsManager.resetToDefaults();
                renderSettingsForm();
            }
        }

        // Close modal on overlay click
        document.getElementById('settingsModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeSettingsModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeSettingsModal();
            }
        });

        // ===== Morning Coach Rendering =====

        function renderMorningCoach() {
            if (!data || typeof RecommendationEngine === 'undefined') return;

            const goals = typeof GoalsManager !== 'undefined' ? GoalsManager.load().goals : {};
            const history = typeof GoalsManager !== 'undefined' ? GoalsManager.loadHistory() : [];
            const analysis = RecommendationEngine.analyzeToday(data, goals, history);

            // Greeting (personalized with user name)
            const userName = localStorage.getItem('health_dashboard_user_name') || '';
            const greetingText = userName ? `${analysis.greeting.text}, ${userName}` : analysis.greeting.text;
            document.getElementById('coachGreeting').textContent = greetingText;
            document.getElementById('coachDate').textContent = analysis.greeting.date;

            // Recovery Protocol (new feature - shown at top when recovery is low)
            renderRecoveryProtocol(data);

            // Readiness
            renderReadiness(analysis.readiness);

            // Recovery Factors
            renderRecoveryFactors(analysis.recoveryFactors);

            // Workout Suggestion
            renderWorkoutSuggestion(analysis.workout);

            // Priority
            renderPriority(analysis.priority);

            // Last Night
            renderLastNight(analysis.yesterday);

            // This Week
            renderThisWeek(analysis.thisWeek);

            // Bedtime Reminder (new feature)
            renderBedtimeCard(data);

            // Goal Suggestions (new feature)
            renderGoalSuggestions(data);
        }

        function renderReadiness(readiness) {
            const circle = document.getElementById('readinessCircle');
            circle.style.borderColor = readiness.color;
            circle.style.color = readiness.color;

            document.getElementById('readinessScoreValue').textContent = readiness.compositeScore;
            document.getElementById('readinessLabel').textContent = readiness.label;
            document.getElementById('readinessDescription').textContent = readiness.description;

            // Render dots
            let dotsHtml = '';
            for (let i = 0; i < 5; i++) {
                const active = i < readiness.dots ? 'active' : '';
                dotsHtml += `<div class="readiness-dot ${active}"></div>`;
            }
            document.getElementById('readinessDots').innerHTML = dotsHtml;
        }

        function renderRecoveryFactors(factors) {
            const container = document.getElementById('recoveryFactors');

            const factorCards = [
                {
                    icon: getIcon('heart'),
                    value: `${factors.hrv.current}ms`,
                    label: 'HRV',
                    status: factors.hrv.status,
                    detail: `${factors.hrv.percentage}%`
                },
                {
                    icon: getIcon('moon'),
                    value: `${factors.deepSleep.value}m`,
                    label: 'Deep Sleep',
                    status: factors.deepSleep.status,
                    detail: `${factors.deepSleep.percentage}%`
                },
                {
                    icon: getIcon('bed'),
                    value: factors.sleepScore.value,
                    label: 'Sleep',
                    status: factors.sleepScore.status,
                    detail: factors.sleepScore.status.label
                },
                {
                    icon: getIcon('activity'),
                    value: factors.stress.summary !== 'unknown' ? factors.stress.summary : '--',
                    label: 'Recovery',
                    status: factors.stress.status,
                    detail: factors.stress.available !== false ? '' : 'N/A'
                }
            ];

            container.innerHTML = factorCards.map(f => `
                <div class="recovery-factor ${f.status.level}">
                    <div class="recovery-factor-icon">${f.icon}</div>
                    <div class="recovery-factor-value">${f.value}</div>
                    <div class="recovery-factor-label">${f.label}</div>
                    <div class="recovery-factor-status" style="color: ${getStatusColor(f.status.level)}">${f.status.label}</div>
                </div>
            `).join('');
        }

        function renderWorkoutSuggestion(workout) {
            const container = document.getElementById('workoutSuggestion');
            container.innerHTML = `
                <div class="workout-icon" style="background: ${workout.color}22; color: ${workout.color}">
                    ${getIcon(workout.icon)}
                </div>
                <div class="workout-info">
                    <div class="workout-label">${workout.label}</div>
                    <div class="workout-duration">${workout.duration} suggested</div>
                    <div class="workout-reason">${workout.reason}</div>
                </div>
            `;
        }

        function renderPriority(priority) {
            const card = document.getElementById('priorityCard');
            card.style.borderLeftColor = priority.color;

            const iconContainer = document.getElementById('priorityIcon');
            iconContainer.style.background = `${priority.color}22`;
            iconContainer.style.color = priority.color;
            iconContainer.innerHTML = getIcon(priority.icon);

            document.getElementById('priorityTitle').textContent = priority.title;
            document.getElementById('priorityAction').textContent = priority.action;
            document.getElementById('priorityReason').textContent = priority.reason;
        }

        function renderLastNight(yesterday) {
            document.getElementById('lastSleepScore').textContent = yesterday.sleepScore || '--';
            document.getElementById('lastHrv').textContent = yesterday.hrv ? `${yesterday.hrv}ms` : '-- ms';
            document.getElementById('lastDeep').textContent = yesterday.deep ? `${yesterday.deep}m` : '-- min';
            document.getElementById('lastRem').textContent = yesterday.rem ? `${yesterday.rem}m` : '-- min';
            document.getElementById('lastEfficiency').textContent = yesterday.efficiency ? `${yesterday.efficiency}%` : '--%';

            // Breath rate from sleep stages
            const lastSleep = data.sleepStages?.last7Days?.[data.sleepStages?.last7Days?.length - 1];
            document.getElementById('lastBreath').textContent = lastSleep?.breathRate ?
                `${lastSleep.breathRate}/min` : '--/min';
        }

        function renderThisWeek(week) {
            document.getElementById('weekWorkouts').textContent = `${week.workouts}/${week.workoutGoal}`;
            document.getElementById('weekSteps').textContent = week.avgSteps ? week.avgSteps.toLocaleString() : '--';
            document.getElementById('weekActiveDays').textContent = `${week.activeDays}/7`;
            document.getElementById('weekHrv').textContent = week.avgHrv ? `${week.avgHrv}ms` : '-- ms';
            document.getElementById('weekDeep').textContent = week.avgDeepSleep ? `${week.avgDeepSleep}m` : '-- min';
            document.getElementById('weekSleep').textContent = data.metrics?.sleepScore || '--';
        }

        function getStatusColor(level) {
            const colors = {
                good: '#10b981',
                normal: '#9ca3af',
                warning: '#f59e0b',
                low: '#ef4444',
                unknown: '#6b7280'
            };
            return colors[level] || colors.unknown;
        }

        function getIcon(name) {
            const icons = {
                'heart': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>',
                'moon': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',
                'bed': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 4v16M2 8h18a2 2 0 0 1 2 2v10M2 17h20M6 8v9"/></svg>',
                'activity': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
                'flame': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>',
                'trending-up': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
                'footprints': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 10 3.8 10 5.5c0 3.11-2 5.66-2 8.68V16a2 2 0 1 1-4 0Z"/><path d="M20 20v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.63 6 14 7.8 14 9.5c0 3.11 2 5.66 2 8.68V20a2 2 0 1 0 4 0Z"/></svg>',
                'pause': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>',
                'alert-octagon': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
                'dumbbell': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6.5 6.5h11M6.5 17.5h11M4 12h16M12 4v16"/></svg>',
                'check-circle': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>'
            };
            return icons[name] || icons['activity'];
        }

        // ===== Smart Health Journal Functions =====

        function scrollToJournal() {
            // Scroll to Smart Health Journal section
            const journalSection = document.getElementById('smartJournalSection');
            if (journalSection) {
                journalSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

                // Expand the journal if collapsed
                const content = document.getElementById('journalContent');
                if (content && !content.classList.contains('expanded')) {
                    toggleJournalSection();
                }

                // Add a highlight effect
                journalSection.style.transition = 'box-shadow 0.3s';
                journalSection.style.boxShadow = '0 0 20px rgba(99, 102, 241, 0.4)';
                setTimeout(() => {
                    journalSection.style.boxShadow = '';
                }, 2000);
            }
        }

        let lifestyleState = {
            evening: {
                caffeine: null,
                alcohol: null,
                lastMealTime: null,
                screenTime: null,
                stress: null
            },
            morning: {
                energy: null,
                sleepFelt: null
            },
            retroCauses: [],
            currentAnomaly: null
        };

        async function initSmartJournal() {
            if (typeof LifestyleManager === 'undefined') {
                console.warn('LifestyleManager not loaded');
                return;
            }

            // Initialize cloud sync (loads from cloud, merges with local)
            try {
                await LifestyleManager.initCloudSync();
                console.log('Cloud sync initialized');
            } catch (err) {
                console.warn('Cloud sync failed, using local data:', err.message);
            }

            // Try to import from old CheckinManager
            LifestyleManager.importFromCheckinManager();

            // Update visibility based on time of day
            updateJournalVisibility();

            // Load existing data
            loadExistingLifestyleData();

            // Update patterns display
            updatePatternsDisplay();

            // Check for anomalies
            checkForAnomalies();

            // Update streaks
            updateJournalStreaks();
        }

        function updateJournalVisibility() {
            const hour = new Date().getHours();
            const morningCard = document.getElementById('morningReflectionCard');
            const eveningCard = document.getElementById('eveningCheckinCard');

            // Morning reflection: 6am - 11am
            if (morningCard) {
                const todayMorning = LifestyleManager.getTodayMorningReflection();
                if (hour >= 6 && hour < 11 && !todayMorning) {
                    morningCard.style.display = 'block';
                } else if (todayMorning) {
                    morningCard.style.display = 'block';
                    updateMorningReflectionStatus(true);
                    loadMorningReflection(todayMorning);
                } else {
                    morningCard.style.display = 'none';
                }
            }

            // Evening check-in: always visible but highlighted after 7pm
            if (eveningCard) {
                const todayEvening = LifestyleManager.getTodayEveningCheckin();
                if (todayEvening) {
                    updateEveningCheckinStatus(true);
                    loadEveningCheckin(todayEvening);
                } else {
                    updateEveningCheckinStatus(false);
                }

                // Update subtitle based on time
                const subtitle = document.getElementById('journalSubtitle');
                if (subtitle) {
                    if (hour >= 19) {
                        subtitle.textContent = 'Time for your evening check-in';
                    } else if (hour >= 6 && hour < 11) {
                        subtitle.textContent = 'How did you sleep?';
                    } else {
                        subtitle.textContent = 'Track lifestyle factors that impact your sleep';
                    }
                }
            }
        }

        function loadExistingLifestyleData() {
            const todayEvening = LifestyleManager.getTodayEveningCheckin();
            const todayMorning = LifestyleManager.getTodayMorningReflection();

            if (todayEvening) {
                loadEveningCheckin(todayEvening);
            }
            if (todayMorning) {
                loadMorningReflection(todayMorning);
            }
        }

        function loadEveningCheckin(checkin) {
            if (checkin.caffeine) selectCaffeine(checkin.caffeine, true);
            if (checkin.alcohol) selectAlcohol(checkin.alcohol, true);
            if (checkin.lastMealTime) selectMealTime(checkin.lastMealTime, true);
            if (checkin.screenTime) selectScreenTime(checkin.screenTime, true);
            if (checkin.stress) selectStress(checkin.stress, true);
        }

        function loadMorningReflection(reflection) {
            if (reflection.energy) selectMorningEnergy(reflection.energy, true);
            if (reflection.sleepFelt) selectSleepFelt(reflection.sleepFelt, true);
        }

        function updateEveningCheckinStatus(completed) {
            const statusEl = document.getElementById('eveningCheckinStatus');
            if (!statusEl) return;

            if (completed) {
                statusEl.innerHTML = '<span class="checkin-status-badge completed"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg> Saved</span>';
            } else {
                const hour = new Date().getHours();
                if (hour >= 19) {
                    statusEl.innerHTML = '<span class="checkin-status-badge pending">~30 sec</span>';
                } else {
                    statusEl.innerHTML = '<span class="checkin-card-time">Best after 7pm</span>';
                }
            }
        }

        function updateMorningReflectionStatus(completed) {
            const statusEl = document.getElementById('morningReflectionStatus');
            if (!statusEl) return;

            if (completed) {
                statusEl.innerHTML = '<span class="checkin-status-badge completed"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg> Saved</span>';
            } else {
                statusEl.innerHTML = '<span class="checkin-status-badge pending">~15 sec</span>';
            }
        }

        function toggleJournalSection() {
            const header = document.getElementById('journalHeader');
            const content = document.getElementById('journalContent');

            if (header && content) {
                header.classList.toggle('expanded');
                content.classList.toggle('visible');
            }
        }

        // Chip Selection Functions
        function selectCaffeine(value, isLoad = false) {
            lifestyleState.evening.caffeine = value;
            updateChipSelection('caffeineChips', value, getChipClass('caffeine', value));
            if (!isLoad) markEveningUnsaved();
        }

        function selectAlcohol(value, isLoad = false) {
            lifestyleState.evening.alcohol = value;
            updateChipSelection('alcoholChips', value, getChipClass('alcohol', value));
            if (!isLoad) markEveningUnsaved();
        }

        function selectMealTime(value, isLoad = false) {
            lifestyleState.evening.lastMealTime = value;
            updateChipSelection('mealTimeChips', value, getChipClass('meal', value));
            if (!isLoad) markEveningUnsaved();
        }

        function selectScreenTime(value, isLoad = false) {
            lifestyleState.evening.screenTime = value;
            updateChipSelection('screenTimeChips', value, getChipClass('screen', value));
            if (!isLoad) markEveningUnsaved();
        }

        function selectStress(level, isLoad = false) {
            lifestyleState.evening.stress = level;
            const stressScale = document.getElementById('stressScale');
            if (stressScale) {
                stressScale.querySelectorAll('.stress-btn').forEach(btn => {
                    const btnLevel = parseInt(btn.dataset.stress);
                    btn.classList.remove('selected', 'low', 'medium', 'high');
                    if (btnLevel === level) {
                        btn.classList.add('selected');
                        if (level <= 2) btn.classList.add('low');
                        else if (level <= 3) btn.classList.add('medium');
                        else btn.classList.add('high');
                    }
                });
            }
            if (!isLoad) markEveningUnsaved();
        }

        function selectMorningEnergy(level, isLoad = false) {
            lifestyleState.morning.energy = level;
            const scale = document.getElementById('morningEnergyScale');
            if (scale) {
                scale.querySelectorAll('.energy-emoji-btn').forEach(btn => {
                    btn.classList.toggle('selected', parseInt(btn.dataset.energy) === level);
                });
            }
            if (!isLoad) markMorningUnsaved();
        }

        function selectSleepFelt(value, isLoad = false) {
            lifestyleState.morning.sleepFelt = value;
            updateChipSelection('sleepFeltChips', value, getChipClass('sleepFelt', value));
            if (!isLoad) markMorningUnsaved();
        }

        function updateChipSelection(containerId, selectedValue, colorClass) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.querySelectorAll('.chip').forEach(chip => {
                chip.classList.remove('selected', 'good', 'warning', 'bad');
                if (chip.dataset.value === selectedValue) {
                    chip.classList.add('selected');
                    if (colorClass) chip.classList.add(colorClass);
                }
            });
        }

        function getChipClass(factor, value) {
            const classes = {
                caffeine: { none: 'good', morning_only: 'good', afternoon: 'warning', evening: 'bad' },
                alcohol: { none: 'good', one_two: 'warning', three_plus: 'bad' },
                meal: { three_plus: 'good', one_two: 'warning', less_one: 'bad' },
                screen: { none: 'good', under_30: 'warning', over_30: 'bad' },
                sleepFelt: { great: 'good', good: 'good', okay: 'warning', poor: 'bad' }
            };
            return classes[factor]?.[value] || '';
        }

        function markEveningUnsaved() {
            const btn = document.getElementById('saveEveningBtn');
            if (btn) {
                btn.textContent = 'Save Check-in';
                btn.disabled = false;
            }
        }

        function markMorningUnsaved() {
            const btn = document.getElementById('saveMorningBtn');
            if (btn) {
                btn.textContent = 'Save Reflection';
                btn.disabled = false;
            }
        }

        function saveEveningCheckin() {
            if (typeof LifestyleManager === 'undefined') return;

            const checkin = {
                caffeine: lifestyleState.evening.caffeine,
                alcohol: lifestyleState.evening.alcohol,
                lastMealTime: lifestyleState.evening.lastMealTime,
                screenTime: lifestyleState.evening.screenTime,
                stress: lifestyleState.evening.stress
            };

            LifestyleManager.saveEveningCheckin(checkin);

            const btn = document.getElementById('saveEveningBtn');
            if (btn) {
                btn.textContent = 'Saved!';
                btn.disabled = true;
            }

            updateEveningCheckinStatus(true);
            updateJournalStreaks();
            updatePatternsDisplay();

            // Update FAB if it exists
            updateFabState();

            console.log('Evening check-in saved:', checkin);
        }

        function saveMorningReflection() {
            if (typeof LifestyleManager === 'undefined') return;

            if (!lifestyleState.morning.energy) {
                alert('Please select your energy level');
                return;
            }

            const reflection = {
                energy: lifestyleState.morning.energy,
                sleepFelt: lifestyleState.morning.sleepFelt
            };

            LifestyleManager.saveMorningReflection(reflection);

            const btn = document.getElementById('saveMorningBtn');
            if (btn) {
                btn.textContent = 'Saved!';
                btn.disabled = true;
            }

            updateMorningReflectionStatus(true);
            updateJournalStreaks();

            console.log('Morning reflection saved:', reflection);
        }

        // Smart Prompts for Anomalies
        function checkForAnomalies() {
            if (typeof LifestyleManager === 'undefined' || !data) return;

            const anomalies = LifestyleManager.detectAnomalies(data);
            const promptCard = document.getElementById('smartPromptCard');

            if (anomalies.length > 0) {
                // Check if user hasn't already responded today
                const anomaly = anomalies[0];
                if (!LifestyleManager.hasRespondedToAnomaly(anomaly.metric)) {
                    lifestyleState.currentAnomaly = anomaly;
                    document.getElementById('smartPromptMessage').textContent = anomaly.message;
                    if (promptCard) promptCard.style.display = 'block';
                    return;
                }
            }

            if (promptCard) promptCard.style.display = 'none';
        }

        function selectCause(cause) {
            const chip = document.querySelector(`.cause-chip[data-cause="${cause}"]`);
            if (chip) {
                chip.classList.toggle('selected');
            }

            // Collect all selected causes
            const selectedCauses = Array.from(document.querySelectorAll('.cause-chip.selected'))
                .map(c => c.dataset.cause);

            lifestyleState.retroCauses = selectedCauses;
        }

        function saveRetroCause() {
            if (typeof LifestyleManager === 'undefined') return;
            if (!lifestyleState.currentAnomaly) return;

            LifestyleManager.saveRetroCause(
                lifestyleState.currentAnomaly.metric,
                lifestyleState.retroCauses
            );

            lifestyleState.currentAnomaly = null;
            lifestyleState.retroCauses = [];
        }

        function saveRetroCauseAndDismiss() {
            saveRetroCause();

            // Hide the prompt card with animation
            const promptCard = document.getElementById('smartPromptCard');
            if (promptCard) {
                promptCard.style.opacity = '0';
                promptCard.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    promptCard.style.display = 'none';
                    promptCard.style.opacity = '1';
                    promptCard.style.transform = 'translateY(0)';
                }, 300);
            }

            console.log('Retro cause saved and dismissed');
        }

        // Patterns Display
        function updatePatternsDisplay() {
            if (typeof LifestyleManager === 'undefined' || !data) return;

            const patternsSection = document.getElementById('patternsSection');
            const notEnoughData = document.getElementById('notEnoughDataMessage');
            const patternsList = document.getElementById('patternsList');
            const patternsDays = document.getElementById('patternsDays');
            const bestSleepSection = document.getElementById('bestSleepSection');
            const bestSleepFactors = document.getElementById('bestSleepFactors');

            const analysis = LifestyleManager.analyzePatterns(data);

            if (!analysis.hasEnoughData) {
                if (patternsSection) patternsSection.style.display = 'none';
                if (notEnoughData) {
                    notEnoughData.style.display = 'block';
                    document.getElementById('notEnoughDataText').textContent =
                        `Check in for ${analysis.daysNeeded} more days to see your personal patterns`;
                }
                return;
            }

            if (notEnoughData) notEnoughData.style.display = 'none';
            if (patternsSection) patternsSection.style.display = 'block';
            if (patternsDays) patternsDays.textContent = `${analysis.daysTracked} days analyzed`;

            // Render patterns
            if (patternsList && analysis.patterns) {
                patternsList.innerHTML = analysis.patterns.slice(0, 4).map(pattern => `
                    <div class="pattern-item ${pattern.impact < 0 ? 'negative' : 'positive'}">
                        <div class="pattern-factor">
                            ${pattern.impact < 0 ? '' : ''} ${pattern.factorName}
                        </div>
                        <div class="pattern-impact"> ${Math.abs(pattern.impact)}% ${pattern.impact < 0 ? 'less' : 'more'} ${pattern.metricName}</div>
                        <div class="pattern-confidence">${pattern.sampleSize} occurrences, ${pattern.confidence > 0.7 ? 'high' : 'moderate'} confidence</div>
                    </div>
                `).join('');
            }

            // Best sleep factors
            const bestFactors = LifestyleManager.getBestSleepFactors(data);
            if (bestFactors && bestFactors.length > 0 && bestSleepSection && bestSleepFactors) {
                bestSleepSection.style.display = 'block';
                bestSleepFactors.innerHTML = bestFactors.map(f => `
                    <span class="best-factor-chip"> ${f.factor} <span class="percentage">(${f.percentage}%)</span></span>
                `).join('');
            } else if (bestSleepSection) {
                bestSleepSection.style.display = 'none';
            }
        }

        function updateJournalStreaks() {
            if (typeof LifestyleManager === 'undefined') return;

            const streaks = LifestyleManager.getStreaks();
            const eveningEl = document.getElementById('eveningStreakValue');
            const morningEl = document.getElementById('morningStreakValue');

            if (eveningEl) {
                eveningEl.textContent = `${streaks.evening.current} day${streaks.evening.current !== 1 ? 's' : ''}`;
            }
            if (morningEl) {
                morningEl.textContent = `${streaks.morning.current} day${streaks.morning.current !== 1 ? 's' : ''}`;
            }
        }

        // ===== Journal FAB Functions =====

        function initCheckinUI() {
            // Update FAB state based on Smart Journal check-in
            updateFabState();
        }

        function updateFabState() {
            const fab = document.getElementById('checkinFab');
            if (!fab) return;

            // Check Smart Journal (LifestyleManager) for evening check-in
            let hasCheckedIn = false;
            if (typeof LifestyleManager !== 'undefined') {
                hasCheckedIn = !!LifestyleManager.getTodayEveningCheckin();
            }

            if (hasCheckedIn) {
                fab.classList.remove('not-checked-in');
                fab.classList.add('checked-in');
                fab.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
            } else {
                fab.classList.add('not-checked-in');
                fab.classList.remove('checked-in');
                fab.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>';
            }
        }

        function renderDashboard() {
            if (!data) return;

            const m = data.metrics || {};

            // Last updated
            if (data.lastUpdated) {
                const updated = new Date(data.lastUpdated);
                document.getElementById('lastUpdated').textContent =
                    `Updated ${updated.toLocaleDateString()} ${updated.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            }

            // Fitness score ring
            const score = m.fitnessScore || 0;
            document.getElementById('fitnessScore').textContent = score;
            const circumference = 2 * Math.PI * 60;
            const offset = circumference - (score / 100) * circumference;
            document.getElementById('scoreProgress').style.strokeDashoffset = offset;

            // Breakdown scores
            document.getElementById('sleepScore').textContent = m.sleepScore || '--';
            document.getElementById('readinessScore').textContent = m.readinessScore || '--';
            document.getElementById('activityScore').textContent = m.activityScore || '--';

            // Sleep card values
            document.getElementById('sleepScoreValue').textContent = m.sleepScore || '--';
            document.getElementById('sleepTrend').textContent = `7-day avg: ${m.sleepScore || '--'}`;

            // Key metrics - Today tab
            document.getElementById('avgSteps').textContent = (m.dailyAvgSteps || 0).toLocaleString();

            // Activity tab metrics
            document.getElementById('activityAvgHr').textContent = `${m.avgHeartRate || '--'} bpm`;
            document.getElementById('activityActiveDays').textContent = `${m.activeDays || 0}/7`;
            document.getElementById('activityWorkouts').textContent = m.totalWorkouts || 0;

            // Changes
            const weekChange = data.insights?.performance?.weekChange || 0;
            const stepsChangeEl = document.getElementById('stepsChange');
            if (stepsChangeEl) {
                stepsChangeEl.textContent = `${weekChange >= 0 ? '+' : ''}${weekChange}% vs last week`;
                stepsChangeEl.className = `metric-change ${weekChange >= 0 ? 'positive' : 'negative'}`;
            }

            // Streaks and stats
            document.getElementById('currentStreak').textContent = `${m.currentStreak || 0} days`;
            document.getElementById('longestStreak').textContent = `${m.longestStreak || 0} days`;
            document.getElementById('bestDay').textContent = `${(m.bestDaySteps || 0).toLocaleString()} (${m.bestDayLabel || 'N/A'})`;
            document.getElementById('totalSteps').textContent = (m.totalSteps30Days || 0).toLocaleString();
            document.getElementById('totalCalories').textContent = (m.totalCalories30Days || 0).toLocaleString();
            document.getElementById('daysTracked').textContent = m.daysTracked || '--';

            // HRV display
            if (data.hrv && data.hrv.current) {
                document.getElementById('hrvValue').textContent = `${data.hrv.current} ms`;
                document.getElementById('hrvBaseline').textContent = `Baseline: ${data.hrv.baseline || '--'} ms`;

                const hrvStatusEl = document.getElementById('hrvStatus');
                hrvStatusEl.textContent = data.hrv.status === 'low' ? 'Below baseline' :
                                          data.hrv.status === 'high' ? 'Above baseline' : 'Normal';
                hrvStatusEl.className = `metric-status ${data.hrv.status || 'normal'}`;
            }

            // Sleep stages display
            if (data.sleepStages && data.sleepStages.last7Days?.length > 0) {
                const latest = data.sleepStages.last7Days[data.sleepStages.last7Days.length - 1];
                document.getElementById('deepSleepValue').textContent = `${latest.deep || '--'} min`;
                document.getElementById('deepSleepAvg').textContent = `Avg: ${data.sleepStages.avgDeep || '--'} min`;
            }

            // Add goal progress bars to metric cards
            if (typeof GoalsManager !== 'undefined') {
                const metrics = getCurrentMetrics();
                renderMetricProgress('stepsCard', 'dailySteps', metrics.dailySteps);
                renderMetricProgress('sleepCard', 'sleepScore', metrics.sleepScore);
                renderMetricProgress('hrvCard', 'hrvBaseline', metrics.hrvBaseline);
                renderMetricProgress('deepSleepCard', 'deepSleepMinutes', metrics.deepSleepMinutes);
            }

            // Render alerts
            renderAlerts();

            // Render stress & recovery and body metrics (moved from Lifestyle tab)
            renderStressAndBodyMetrics();

            // Render heatmap
            renderHeatmap();

            // Charts are now initialized lazily when Activity tab is shown
            // This improves initial load performance
        }

        function renderAlerts() {
            const container = document.getElementById('alertsGrid');
            const alerts = data.alerts || [];

            if (alerts.length === 0) {
                container.innerHTML = '<div class="alert-card success"><div class="alert-icon">&#9989;</div><div><div class="alert-title">All Good</div><div class="alert-message">No health concerns detected</div></div></div>';
                return;
            }

            container.innerHTML = alerts.map(alert => `
                <div class="alert-card ${alert.type}">
                    <div class="alert-icon">${alert.type === 'warning' ? '&#9888;' : '&#9989;'}</div>
                    <div>
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-message">${alert.message}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderStressAndBodyMetrics() {
            if (!data) return;

            // Stress & Recovery data
            const stress = data.stress || {};
            const stressToday = stress.today || {};

            // Stress Score (minutes of stress)
            if (stressToday.stressMinutes !== undefined) {
                document.getElementById('stressScore').textContent = stressToday.stressMinutes + ' min';
                const summary = stressToday.summary || 'unknown';
                document.getElementById('stressLevel').textContent = summary.charAt(0).toUpperCase() + summary.slice(1);
                document.getElementById('stressLevel').className = `metric-change ${summary === 'restored' ? 'positive' : summary === 'stressful' ? 'negative' : ''}`;
            }

            // Recovery Time
            if (stressToday.recoveryMinutes !== undefined) {
                document.getElementById('recoveryTime').textContent = stressToday.recoveryMinutes + ' min';
                document.getElementById('recoveryStatus').textContent = stressToday.recoveryMinutes > 30 ? 'Good' : 'Low';
                document.getElementById('recoveryStatus').className = `metric-change ${stressToday.recoveryMinutes > 30 ? 'positive' : 'negative'}`;
            }

            // Resilience (using readiness recovery index as proxy)
            const readinessBreakdown = data.readinessBreakdown || {};
            if (readinessBreakdown.recoveryIndex) {
                document.getElementById('resilienceScore').textContent = readinessBreakdown.recoveryIndex;
                const resLevel = readinessBreakdown.recoveryIndex >= 80 ? 'Strong' : readinessBreakdown.recoveryIndex >= 60 ? 'Good' : 'Building';
                document.getElementById('resilienceLevel').textContent = resLevel;
                document.getElementById('resilienceLevel').className = `metric-change ${readinessBreakdown.recoveryIndex >= 60 ? 'positive' : ''}`;
            }

            // Average Stress
            if (stress.avgStressMinutes) {
                document.getElementById('dayStress').textContent = stress.avgStressMinutes + ' min';
                document.getElementById('dayStressDetail').textContent = '7-day avg';
            }

            // Body Metrics
            // SpO2
            if (data.spo2 && data.spo2.current) {
                document.getElementById('spo2Value').textContent = data.spo2.current.toFixed(1) + '%';
                const spo2Status = data.spo2.current >= 95 ? 'Normal' : 'Low';
                document.getElementById('spo2Status').textContent = spo2Status;
                document.getElementById('spo2Status').className = `metric-change ${data.spo2.current >= 95 ? 'positive' : 'negative'}`;
            }

            // Resting HR
            const restingHR = data.metrics?.restingHR;
            if (restingHR) {
                document.getElementById('restingHRValue').textContent = restingHR + ' bpm';
                const hrStatus = restingHR < 50 ? 'Athletic' : restingHR < 60 ? 'Excellent' : restingHR < 70 ? 'Good' : 'Normal';
                document.getElementById('restingHRTrend').textContent = hrStatus;
                document.getElementById('restingHRTrend').className = `metric-change ${restingHR < 70 ? 'positive' : ''}`;
            }

            // Body Temp Deviation
            const tempDeviation = readinessBreakdown.tempDeviation;
            if (tempDeviation !== undefined && tempDeviation !== null) {
                document.getElementById('bodyTempValue').textContent = (tempDeviation >= 0 ? '+' : '') + tempDeviation.toFixed(2) + '';
                const tempStatus = Math.abs(tempDeviation) < 0.5 ? 'Normal' : tempDeviation > 0 ? 'Elevated' : 'Low';
                document.getElementById('bodyTempDeviation').textContent = tempStatus;
                document.getElementById('bodyTempDeviation').className = `metric-change ${Math.abs(tempDeviation) < 0.5 ? 'positive' : ''}`;
            }

            // Breath Rate
            const breathRate = data.sleepStages?.lastNight?.breathRate || data.sleepStages?.avgBreathRate;
            if (breathRate) {
                document.getElementById('breathRateValue').textContent = breathRate.toFixed(1) + '/min';
                const breathStatus = breathRate >= 12 && breathRate <= 20 ? 'Normal' : 'Check';
                document.getElementById('breathRateStatus').textContent = breathStatus;
                document.getElementById('breathRateStatus').className = `metric-change ${breathStatus === 'Normal' ? 'positive' : 'negative'}`;
            }
        }

        function renderHeatmap() {
            const container = document.getElementById('heatmapGrid');
            const labels = data.last7Days?.labels || [];
            const values = data.last7Days?.values || [];

            container.innerHTML = labels.map((day, i) => {
                const steps = values[i] || 0;
                const percent = (steps / 10000) * 100;
                let bg;
                if (percent >= 100) bg = 'rgba(16, 185, 129, 0.25)';
                else if (percent >= 75) bg = 'rgba(99, 102, 241, 0.25)';
                else if (percent >= 50) bg = 'rgba(245, 158, 11, 0.2)';
                else bg = 'rgba(239, 68, 68, 0.15)';

                return `
                    <div class="heatmap-day" style="background: ${bg}">
                        <div class="day-label">${day}</div>
                        <div class="day-value">${steps >= 1000 ? (steps/1000).toFixed(1) + 'k' : steps}</div>
                    </div>
                `;
            }).join('');
        }

        function initCharts() {
            const chartDefaults = {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#6b7280', font: { size: 11 } }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#6b7280', font: { size: 11 } }
                    }
                }
            };

            // Steps chart
            new Chart(document.getElementById('stepsChart'), {
                type: 'line',
                data: {
                    labels: data.last7Days?.labels || [],
                    datasets: [{
                        data: data.last7Days?.values || [],
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#6366f1'
                    }]
                },
                options: {
                    ...chartDefaults,
                    scales: {
                        ...chartDefaults.scales,
                        y: {
                            ...chartDefaults.scales.y,
                            ticks: {
                                ...chartDefaults.scales.y.ticks,
                                callback: v => (v/1000).toFixed(0) + 'k'
                            }
                        }
                    }
                }
            });

            // Heart rate chart
            new Chart(document.getElementById('heartChart'), {
                type: 'line',
                data: {
                    labels: data.heartRateTrends?.labels || [],
                    datasets: [{
                        label: 'Avg',
                        data: data.heartRateTrends?.values || [],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#ef4444'
                    }]
                },
                options: chartDefaults
            });

            // Workout chart
            const workoutLabels = data.workoutDistribution?.labels || [];
            const workoutValues = data.workoutDistribution?.values || [];

            new Chart(document.getElementById('workoutChart'), {
                type: 'doughnut',
                data: {
                    labels: workoutLabels.length > 0 ? workoutLabels : ['No workouts'],
                    datasets: [{
                        data: workoutValues.length > 0 ? workoutValues : [1],
                        backgroundColor: workoutLabels.length > 0
                            ? ['#6366f1', '#10b981', '#f59e0b', '#ef4444']
                            : ['#374151'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#9ca3af', padding: 12, font: { size: 11 } }
                        }
                    }
                }
            });

            // Weekly comparison chart
            new Chart(document.getElementById('weeklyChart'), {
                type: 'bar',
                data: {
                    labels: data.weeklyComparison?.labels || [],
                    datasets: [{
                        data: data.weeklyComparison?.steps || [],
                        backgroundColor: data.weeklyComparison?.steps?.map((_, i) =>
                            i === 3 ? '#6366f1' : 'rgba(99, 102, 241, 0.4)'
                        ) || [],
                        borderRadius: 6
                    }]
                },
                options: {
                    ...chartDefaults,
                    scales: {
                        ...chartDefaults.scales,
                        y: {
                            ...chartDefaults.scales.y,
                            ticks: {
                                ...chartDefaults.scales.y.ticks,
                                callback: v => (v/1000).toFixed(0) + 'k'
                            }
                        }
                    }
                }
            });

            chartsInitialized = true;
        }

        // ==================== SLEEP TAB ====================

        function initSleepCharts() {
            if (sleepChartsInitialized) return;

            const chartDefaults = {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                    legend: { display: false }
                }
            };

            // Get sleep data from correct paths
            const sleepStages = data.sleepStages || {};
            const lastNight = sleepStages.lastNight || {};
            const last7Days = sleepStages.last7Days || [];
            const hrv = data.hrv || {};

            // Sleep stages doughnut chart
            const deepSleep = lastNight.deep || 0;
            const remSleep = lastNight.rem || 0;
            const lightSleep = lastNight.light || 0;
            const awake = lastNight.awake || 0;

            const sleepStagesCanvas = document.getElementById('sleepStagesChart');
            if (sleepStagesCanvas) {
                new Chart(sleepStagesCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: ['Deep', 'REM', 'Light', 'Awake'],
                        datasets: [{
                            data: [deepSleep, remSleep, lightSleep, awake],
                            backgroundColor: ['#8b5cf6', '#6366f1', '#a78bfa', '#374151'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#9ca3af', padding: 12, font: { size: 11 } }
                            }
                        }
                    }
                });
            }

            // Sleep efficiency line chart (7-day trend)
            const sleepEffCanvas = document.getElementById('sleepEfficiencyChart');
            if (sleepEffCanvas) {
                // Extract efficiency values from last7Days array
                const efficiencyLabels = last7Days.slice(-7).map(d => {
                    if (d.day) {
                        const date = new Date(d.day);
                        return date.toLocaleDateString('en-US', { weekday: 'short' });
                    }
                    return '';
                });
                const efficiencyValues = last7Days.slice(-7).map(d => d.efficiency || 0);

                new Chart(sleepEffCanvas, {
                    type: 'line',
                    data: {
                        labels: efficiencyLabels.length > 0 ? efficiencyLabels : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            data: efficiencyValues.length > 0 ? efficiencyValues : [85, 88, 82, 90, 87, 91, 89],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 4,
                            pointBackgroundColor: '#10b981'
                        }]
                    },
                    options: {
                        ...chartDefaults,
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 60,
                                max: 100,
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { color: '#6b7280', font: { size: 11 }, callback: v => v + '%' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: '#6b7280', font: { size: 11 } }
                            }
                        }
                    }
                });
            }

            // HRV trend chart
            const hrvCanvas = document.getElementById('hrvTrendChart');
            if (hrvCanvas) {
                // Use hrv.trend7Days array
                const hrvValues = hrv.trend7Days || [];
                const hrvLabels = data.last7Days?.labels || ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

                new Chart(hrvCanvas, {
                    type: 'line',
                    data: {
                        labels: hrvLabels.slice(-7),
                        datasets: [{
                            data: hrvValues.slice(-7),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 4,
                            pointBackgroundColor: '#10b981'
                        }]
                    },
                    options: {
                        ...chartDefaults,
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { color: '#6b7280', font: { size: 11 }, callback: v => v + ' ms' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: '#6b7280', font: { size: 11 } }
                            }
                        }
                    }
                });
            }

            sleepChartsInitialized = true;
        }

        function renderSleepTab() {
            if (!data) return;

            const sleepStages = data.sleepStages || {};
            const lastNight = sleepStages.lastNight || {};
            const hrv = data.hrv || {};
            const metrics = data.metrics || {};

            // Sleep metrics
            document.getElementById('sleepTabScore').textContent = metrics.sleepScore || '--';
            document.getElementById('sleepTabHrv').textContent = (hrv.current || '--') + ' ms';
            document.getElementById('sleepTabDeep').textContent = (lastNight.deep || '--') + ' min';
            document.getElementById('sleepTabRem').textContent = (lastNight.rem || '--') + ' min';

            // Trends - calculate from 7-day avg vs current
            const currentScore = metrics.sleepScore || 0;
            const avgScore = sleepStages.avgEfficiency || currentScore;
            const sleepTrend = avgScore ? Math.round(((currentScore - avgScore) / avgScore) * 100) : 0;
            const sleepTrendEl = document.getElementById('sleepTabTrend');
            sleepTrendEl.textContent = `7-day avg: ${metrics.sleepScore || '--'}`;
            sleepTrendEl.className = 'metric-change positive';

            // Baselines/Averages
            document.getElementById('sleepTabHrvBaseline').textContent = `Baseline: ${hrv.baseline || '--'} ms`;
            document.getElementById('sleepTabDeepAvg').textContent = `Avg: ${sleepStages.avgDeep || '--'} min`;
            document.getElementById('sleepTabRemAvg').textContent = `Avg: ${sleepStages.avgRem || '--'} min`;

            // Last night summary
            const totalMinutes = lastNight.total || 0;
            const totalHours = totalMinutes ? (totalMinutes / 60).toFixed(1) : '--';
            document.getElementById('sleepTabTotal').textContent = totalHours + ' hrs';
            document.getElementById('sleepTabEfficiency').textContent = (lastNight.efficiency || '--') + '%';
            document.getElementById('sleepTabBreath').textContent = (lastNight.breathRate || '--') + '/min';

            // Calculate bedtime/wake time from day if available
            const sleepDay = lastNight.day || '';
            document.getElementById('sleepTabBedtime').textContent = sleepDay ? 'Night of ' + sleepDay.slice(5) : '--';
            document.getElementById('sleepTabWake').textContent = lastNight.latency ? lastNight.latency + ' min latency' : '--';

            // Calculate restfulness from efficiency
            const efficiency = lastNight.efficiency || 0;
            let restfulness = '--';
            if (efficiency >= 90) restfulness = 'Excellent';
            else if (efficiency >= 80) restfulness = 'Good';
            else if (efficiency >= 70) restfulness = 'Fair';
            else if (efficiency > 0) restfulness = 'Poor';
            document.getElementById('sleepTabRestful').textContent = restfulness;
        }

        // ==================== LIFESTYLE TAB ====================

        let inlineCheckinState = {
            energy: null,
            tags: []
        };

        function renderLifestyleTab() {
            if (!data) return;

            // Stress & Recovery data
            const stress = data.stress || {};
            const stressToday = stress.today || {};

            // Stress Score (minutes of stress)
            if (stressToday.stressMinutes !== undefined) {
                document.getElementById('stressScore').textContent = stressToday.stressMinutes + ' min';
                const summary = stressToday.summary || 'unknown';
                document.getElementById('stressLevel').textContent = summary.charAt(0).toUpperCase() + summary.slice(1);
                document.getElementById('stressLevel').className = `metric-change ${summary === 'restored' ? 'positive' : summary === 'stressful' ? 'negative' : ''}`;
            }

            // Recovery Time
            if (stressToday.recoveryMinutes !== undefined) {
                document.getElementById('recoveryTime').textContent = stressToday.recoveryMinutes + ' min';
                document.getElementById('recoveryStatus').textContent = stressToday.recoveryMinutes > 30 ? 'Good' : 'Low';
                document.getElementById('recoveryStatus').className = `metric-change ${stressToday.recoveryMinutes > 30 ? 'positive' : 'negative'}`;
            }

            // Resilience (using readiness recovery index as proxy)
            const readinessBreakdown = data.readinessBreakdown || {};
            if (readinessBreakdown.recoveryIndex) {
                document.getElementById('resilienceScore').textContent = readinessBreakdown.recoveryIndex;
                const resLevel = readinessBreakdown.recoveryIndex >= 80 ? 'Strong' : readinessBreakdown.recoveryIndex >= 60 ? 'Good' : 'Building';
                document.getElementById('resilienceLevel').textContent = resLevel;
                document.getElementById('resilienceLevel').className = `metric-change ${readinessBreakdown.recoveryIndex >= 60 ? 'positive' : ''}`;
            }

            // Average Stress
            if (stress.avgStressMinutes) {
                document.getElementById('dayStress').textContent = stress.avgStressMinutes + ' min';
                document.getElementById('dayStressDetail').textContent = '7-day avg';
            }

            // Body Metrics
            // SpO2
            if (data.spo2 && data.spo2.current) {
                document.getElementById('spo2Value').textContent = data.spo2.current.toFixed(1) + '%';
                const spo2Status = data.spo2.current >= 95 ? 'Normal' : 'Low';
                document.getElementById('spo2Status').textContent = spo2Status;
                document.getElementById('spo2Status').className = `metric-change ${data.spo2.current >= 95 ? 'positive' : 'negative'}`;
            }

            // Resting HR
            const restingHR = data.metrics?.restingHR;
            if (restingHR) {
                document.getElementById('restingHRValue').textContent = restingHR + ' bpm';
                const hrStatus = restingHR < 50 ? 'Athletic' : restingHR < 60 ? 'Excellent' : restingHR < 70 ? 'Good' : 'Normal';
                document.getElementById('restingHRTrend').textContent = hrStatus;
                document.getElementById('restingHRTrend').className = `metric-change ${restingHR < 70 ? 'positive' : ''}`;
            }

            // Body Temp Deviation
            const tempDeviation = readinessBreakdown.tempDeviation;
            if (tempDeviation !== undefined && tempDeviation !== null) {
                document.getElementById('bodyTempValue').textContent = (tempDeviation >= 0 ? '+' : '') + tempDeviation.toFixed(2) + '';
                const tempStatus = Math.abs(tempDeviation) < 0.5 ? 'Normal' : tempDeviation > 0 ? 'Elevated' : 'Low';
                document.getElementById('bodyTempDeviation').textContent = tempStatus;
                document.getElementById('bodyTempDeviation').className = `metric-change ${Math.abs(tempDeviation) < 0.5 ? 'positive' : ''}`;
            }

            // Breath Rate
            const breathRate = data.sleepStages?.lastNight?.breathRate || data.sleepStages?.avgBreathRate;
            if (breathRate) {
                document.getElementById('breathRateValue').textContent = breathRate.toFixed(1) + '/min';
                const breathStatus = breathRate >= 12 && breathRate <= 20 ? 'Normal' : 'Check';
                document.getElementById('breathRateStatus').textContent = breathStatus;
                document.getElementById('breathRateStatus').className = `metric-change ${breathStatus === 'Normal' ? 'positive' : 'negative'}`;
            }

            // Load saved inline check-in state
            loadInlineCheckinState();

            // Load energy logs
            renderEnergyLogs();
        }

        function logEnergy(level) {
            if (typeof NutritionManager === 'undefined') {
                console.warn('NutritionManager not loaded');
                return;
            }

            // Add energy entry
            NutritionManager.addEnergy(level);

            // Flash the selected button briefly
            const btn = document.querySelector(`#inlineEnergyRating .energy-btn[data-energy="${level}"]`);
            if (btn) {
                btn.classList.add('selected');
                setTimeout(() => btn.classList.remove('selected'), 600);
            }

            // Update the logs display
            renderEnergyLogs();
        }

        function renderEnergyLogs() {
            if (typeof NutritionManager === 'undefined') return;

            const progress = NutritionManager.getEnergyProgress();
            const logsContainer = document.getElementById('energyLogs');
            const summaryEl = document.getElementById('energySummary');

            // Update summary
            if (summaryEl) {
                if (progress.count > 0) {
                    summaryEl.textContent = `Avg: ${progress.average} (${progress.count} ${progress.count === 1 ? 'entry' : 'entries'})`;
                } else {
                    summaryEl.textContent = '';
                }
            }

            // Render logs
            if (logsContainer && progress.logs.length > 0) {
                const levelLabels = { 1: 'Low', 2: 'Fair', 3: 'Good', 4: 'Great', 5: 'Peak' };
                logsContainer.innerHTML = progress.logs.map((log, idx) => `
                    <div class="energy-log-item">
                        <span class="energy-log-level">${log.level}</span>
                        <span class="energy-log-time">${formatTime12h(log.time)}</span>
                        ${idx === progress.logs.length - 1 ? `<button class="energy-log-remove" onclick="removeLastEnergy()" title="Remove"></button>` : ''}
                    </div>
                `).join('');
            } else if (logsContainer) {
                logsContainer.innerHTML = '';
            }
        }

        function formatTime12h(time24) {
            const [hours, minutes] = time24.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${h12}:${minutes} ${ampm}`;
        }

        function removeLastEnergy() {
            if (typeof NutritionManager === 'undefined') return;
            NutritionManager.removeLastEnergy();
            renderEnergyLogs();
        }

        function toggleInlineTag(tag) {
            const index = inlineCheckinState.tags.indexOf(tag);
            if (index > -1) {
                inlineCheckinState.tags.splice(index, 1);
            } else {
                inlineCheckinState.tags.push(tag);
            }

            // Update UI
            document.querySelectorAll('#inlineTagsGrid .tag-btn').forEach(btn => {
                btn.classList.toggle('selected', inlineCheckinState.tags.includes(btn.dataset.tag));
            });

            // Save state
            saveInlineCheckinState();
        }

        function getLocalDateString() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }

        function saveInlineCheckinState() {
            const today = getLocalDateString();
            localStorage.setItem('inlineCheckin_' + today, JSON.stringify(inlineCheckinState));
        }

        function loadInlineCheckinState() {
            const today = getLocalDateString();
            const saved = localStorage.getItem('inlineCheckin_' + today);

            if (saved) {
                inlineCheckinState = JSON.parse(saved);

                // Restore energy selection
                if (inlineCheckinState.energy) {
                    document.querySelectorAll('#inlineEnergyRating .energy-btn').forEach(btn => {
                        btn.classList.toggle('selected', parseInt(btn.dataset.energy) === inlineCheckinState.energy);
                    });
                }

                // Restore tag selections
                if (inlineCheckinState.tags && inlineCheckinState.tags.length > 0) {
                    document.querySelectorAll('#inlineTagsGrid .tag-btn').forEach(btn => {
                        btn.classList.toggle('selected', inlineCheckinState.tags.includes(btn.dataset.tag));
                    });
                }
            }
        }

        // ==================== NUTRITION UI ====================

        function initNutritionUI() {
            if (typeof NutritionManager === 'undefined') return;

            // Render initial state
            renderNutritionUI();

            // Water buttons
            document.getElementById('waterMinus')?.addEventListener('click', () => {
                NutritionManager.removeWater(1);
                renderNutritionUI();
            });

            document.getElementById('waterPlus1')?.addEventListener('click', () => {
                NutritionManager.addWater(1);
                renderNutritionUI();
            });

            document.getElementById('waterPlus2')?.addEventListener('click', () => {
                NutritionManager.addWater(2);
                renderNutritionUI();
            });

            // Protein buttons
            document.querySelectorAll('.protein-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const rating = btn.dataset.rating;
                    NutritionManager.setProteinRating(rating);
                    renderNutritionUI();
                });
            });

            // Food quality buttons
            document.querySelectorAll('.quality-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const quality = parseInt(btn.dataset.quality);
                    NutritionManager.setFoodQuality(quality);
                    renderNutritionUI();
                });
            });

            // Meal log button
            document.getElementById('logMealBtn')?.addEventListener('click', openMealLogModal);
        }

        function renderNutritionUI() {
            if (typeof NutritionManager === 'undefined') return;

            const summary = NutritionManager.getTodaySummary();

            // Water
            const waterProgress = summary.water;
            document.getElementById('waterCount').textContent = waterProgress.current;
            document.getElementById('waterGoal').textContent = waterProgress.goal;
            document.getElementById('waterPercentage').textContent = `${waterProgress.percentage}%`;
            document.getElementById('waterProgressFill').style.width = `${waterProgress.percentage}%`;

            if (waterProgress.remaining > 0) {
                document.getElementById('waterRemaining').textContent =
                    `${waterProgress.remaining} glass${waterProgress.remaining !== 1 ? 'es' : ''} to go`;
            } else {
                document.getElementById('waterRemaining').textContent = 'Goal reached!';
                document.getElementById('waterRemaining').style.color = '#10b981';
            }

            // Protein
            const protein = summary.protein;
            document.querySelectorAll('.protein-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.rating === protein.rating);
            });

            if (protein.grams) {
                document.getElementById('proteinEstimate').textContent = `~${protein.grams}g`;
            } else {
                document.getElementById('proteinEstimate').textContent = '--';
            }

            // Food Quality
            const foodQuality = summary.foodQuality;
            document.querySelectorAll('.quality-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.quality) === foodQuality);
            });

            if (foodQuality) {
                document.getElementById('qualityScore').textContent = `${foodQuality}/5`;
                const qualityLabels = {
                    1: 'Poor - Mostly processed foods',
                    2: 'Below Average - More junk than whole foods',
                    3: 'Balanced - Mix of both',
                    4: 'Good - Mostly whole foods',
                    5: 'Excellent - All nutritious whole foods'
                };
                document.getElementById('qualityDescription').textContent = qualityLabels[foodQuality] || '';
            } else {
                document.getElementById('qualityScore').textContent = '--';
                document.getElementById('qualityDescription').textContent = 'Rate your food choices';
            }

            // Meals
            const meals = summary.meals;
            document.getElementById('mealCount').textContent =
                `${meals.length} meal${meals.length !== 1 ? 's' : ''} logged today`;

            const mealsList = document.getElementById('mealsList');
            mealsList.innerHTML = '';

            meals.forEach(meal => {
                const mealItem = document.createElement('div');
                mealItem.className = 'meal-item';
                mealItem.innerHTML = `
                    <span class="meal-item-time">${meal.time}</span>
                    <span class="meal-item-desc">${meal.description || meal.type || 'Meal'}</span>
                    ${meal.aiAnalysis?.totals?.protein ?
                        `<span class="meal-item-protein">${meal.aiAnalysis.totals.protein}g protein</span>` : ''}
                `;
                mealsList.appendChild(mealItem);
            });
        }

        function openMealLogModal() {
            // Create a simple meal log modal
            const existingModal = document.getElementById('mealLogModal');
            if (existingModal) {
                existingModal.classList.add('active');
                return;
            }

            const overlay = document.createElement('div');
            overlay.id = 'mealLogModal';
            overlay.className = 'modal-overlay';
            overlay.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2 class="modal-title">Log Meal</h2>
                        <button class="modal-close" id="mealModalClose">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Meal Type</label>
                            <div class="meal-type-buttons">
                                <button class="meal-type-btn" data-type="breakfast">Breakfast</button>
                                <button class="meal-type-btn" data-type="lunch">Lunch</button>
                                <button class="meal-type-btn" data-type="dinner">Dinner</button>
                                <button class="meal-type-btn" data-type="snack">Snack</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea id="mealDescription" class="form-textarea" rows="3"
                                placeholder="e.g., Grilled chicken with rice and vegetables"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estimated Protein (optional)</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="number" id="mealProtein" class="form-input"
                                    style="width: 100px;" placeholder="0" min="0" max="200">
                                <span style="color: var(--text-secondary);">grams</span>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 16px;">
                            <label class="form-label">Photo (optional)</label>
                            <div class="photo-upload-area" id="photoUploadArea">
                                <input type="file" id="mealPhotoInput" accept="image/*" style="display: none;">
                                <div id="photoPreview" style="display: none;">
                                    <img id="photoPreviewImg" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                                </div>
                                <button class="meal-log-btn" id="selectPhotoBtn" style="margin-top: 0;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                    <span>Add Photo</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" id="mealModalCancel">Cancel</button>
                        <button class="btn btn-primary" id="mealModalSave">Save Meal</button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            // Add event listeners (using addEventListener instead of onclick)
            document.getElementById('mealModalClose').addEventListener('click', closeMealLogModal);
            document.getElementById('mealModalCancel').addEventListener('click', closeMealLogModal);
            document.getElementById('mealModalSave').addEventListener('click', saveMealLog);

            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeMealLogModal();
                }
            });

            // Add styles for new elements
            const style = document.createElement('style');
            style.textContent = `
                .meal-type-buttons {
                    display: flex;
                    gap: 8px;
                    flex-wrap: wrap;
                }
                .meal-type-btn {
                    padding: 10px 16px;
                    border: 1px solid var(--border);
                    border-radius: 8px;
                    background: var(--bg-elevated);
                    color: var(--text-primary);
                    cursor: pointer;
                    transition: all 0.2s;
                }
                .meal-type-btn:hover {
                    border-color: #8b5cf6;
                }
                .meal-type-btn.selected {
                    background: rgba(139, 92, 246, 0.15);
                    border-color: #8b5cf6;
                    color: #8b5cf6;
                }
                .form-textarea {
                    width: 100%;
                    padding: 12px;
                    border: 1px solid var(--border);
                    border-radius: 8px;
                    background: var(--bg-elevated);
                    color: var(--text-primary);
                    font-family: inherit;
                    font-size: 14px;
                    resize: vertical;
                }
                .form-textarea:focus {
                    outline: none;
                    border-color: var(--accent);
                }
                .photo-upload-area {
                    border: 2px dashed var(--border);
                    border-radius: 10px;
                    padding: 16px;
                    text-align: center;
                }
            `;
            document.head.appendChild(style);

            // Event listeners
            document.querySelectorAll('.meal-type-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.meal-type-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                });
            });

            document.getElementById('selectPhotoBtn').addEventListener('click', () => {
                document.getElementById('mealPhotoInput').click();
            });

            document.getElementById('mealPhotoInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('photoPreviewImg').src = e.target.result;
                        document.getElementById('photoPreview').style.display = 'block';
                        document.getElementById('selectPhotoBtn').innerHTML = `
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            <span>Photo Added</span>
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            });

            overlay.classList.add('active');
        }

        function closeMealLogModal() {
            const modal = document.getElementById('mealLogModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function saveMealLog() {
            const mealType = document.querySelector('.meal-type-btn.selected')?.dataset.type || 'meal';
            const description = document.getElementById('mealDescription').value;
            const protein = parseInt(document.getElementById('mealProtein').value) || 0;
            const photoImg = document.getElementById('photoPreviewImg');
            const photo = photoImg?.src || null;

            if (!description && !photo) {
                alert('Please add a description or photo');
                return;
            }

            const meal = {
                type: mealType,
                description: description,
                photo: photo,
                aiAnalysis: protein > 0 ? {
                    totals: { protein: protein }
                } : null
            };

            NutritionManager.addMeal(meal);
            closeMealLogModal();
            renderNutritionUI();

            // Reset form
            document.querySelectorAll('.meal-type-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('mealDescription').value = '';
            document.getElementById('mealProtein').value = '';
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('selectPhotoBtn').innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21 15 16 10 5 21"/>
                </svg>
                <span>Add Photo</span>
            `;
        }

        // ==================== TRENDS & ANALYTICS UI ====================

        let selectedTimeRange = '7d';
        let historicalData = [];

        function initTrendsUI() {
            if (typeof AnalyticsEngine === 'undefined') return;

            // Generate historical data for demo (in production, this would come from stored data)
            historicalData = AnalyticsEngine.generateHistoricalData(data, 90);

            // Time range selector
            document.querySelectorAll('.range-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedTimeRange = btn.dataset.range;
                    renderTrendsUI();
                });
            });

            // Export button
            document.getElementById('exportDataBtn')?.addEventListener('click', exportHealthData);

            // Initial render
            renderTrendsUI();
        }

        function renderTrendsUI() {
            if (typeof AnalyticsEngine === 'undefined' || historicalData.length === 0) return;

            renderComparison();
            renderPersonalRecords();
            renderMilestones();
        }

        function renderComparison() {
            const days = parseInt(selectedTimeRange) || 7;
            const labels = AnalyticsEngine.getComparisonLabel(selectedTimeRange);

            document.getElementById('currentPeriodLabel').textContent = labels.current;
            document.getElementById('previousPeriodLabel').textContent = labels.previous;

            // Split data into current and previous periods
            const currentPeriod = historicalData.slice(-days);
            const previousPeriod = historicalData.slice(-days * 2, -days);

            const comparison = AnalyticsEngine.comparePeriods(
                currentPeriod,
                previousPeriod,
                ['steps', 'sleepScore', 'hrv', 'workout']
            );

            // Steps
            updateComparisonMetric('Steps', comparison.steps);

            // Sleep
            updateComparisonMetric('Sleep', comparison.sleepScore);

            // HRV
            updateComparisonMetric('Hrv', comparison.hrv);

            // Workouts - count instead of average
            const currentWorkouts = currentPeriod.filter(d => d.workout).length;
            const previousWorkouts = previousPeriod.filter(d => d.workout).length;
            const workoutDelta = currentWorkouts - previousWorkouts;

            document.getElementById('compWorkoutsCurrent').textContent = currentWorkouts;
            document.getElementById('compWorkoutsPrevious').textContent = previousWorkouts;

            const workoutDeltaEl = document.getElementById('compWorkoutsDelta');
            workoutDeltaEl.textContent = `${workoutDelta >= 0 ? '+' : ''}${workoutDelta}`;
            workoutDeltaEl.className = `comparison-delta ${workoutDelta > 0 ? 'positive' : workoutDelta < 0 ? 'negative' : 'neutral'}`;
        }

        function updateComparisonMetric(name, data) {
            if (!data) return;

            const currentEl = document.getElementById(`comp${name}Current`);
            const previousEl = document.getElementById(`comp${name}Previous`);
            const deltaEl = document.getElementById(`comp${name}Delta`);

            if (currentEl) currentEl.textContent = data.current.toLocaleString();
            if (previousEl) previousEl.textContent = data.previous.toLocaleString();

            if (deltaEl) {
                const sign = data.delta >= 0 ? '+' : '';
                deltaEl.textContent = `${sign}${data.percentChange}%`;
                deltaEl.className = `comparison-delta ${data.improved ? 'positive' : data.delta === 0 ? 'neutral' : 'negative'}`;
            }
        }

        function renderPersonalRecords() {
            const prs = AnalyticsEngine.findPersonalRecords(historicalData);
            const grid = document.getElementById('recordsGrid');
            if (!grid) return;

            // Select which PRs to show
            const prKeys = ['maxSteps', 'maxHrv', 'maxSleepScore', 'maxDeepSleep'];
            let html = '';

            prKeys.forEach(key => {
                const pr = prs[key];
                if (!pr || pr.value === null) return;

                const dateStr = pr.date ? new Date(pr.date).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                }) : '';

                // Get current value for comparison
                let currentValue = null;
                if (key === 'maxSteps') currentValue = data.today?.steps;
                else if (key === 'maxHrv') currentValue = data.hrv?.current;
                else if (key === 'maxSleepScore') currentValue = data.metrics?.sleepScore;
                else if (key === 'maxDeepSleep') currentValue = data.sleepStages?.lastNight?.deep;

                const percentage = currentValue && pr.value ? Math.round((currentValue / pr.value) * 100) : null;

                html += `
                    <div class="record-card">
                        <div class="record-icon">
                            ${getRecordIcon(pr.icon)}
                        </div>
                        <div class="record-label">${pr.label}</div>
                        <div class="record-value">
                            ${pr.value.toLocaleString()}
                            ${pr.unit ? `<span class="record-unit">${pr.unit}</span>` : ''}
                        </div>
                        ${dateStr ? `<div class="record-date">${dateStr}</div>` : ''}
                        ${percentage ? `<div class="record-current">Today: ${percentage}% of PR</div>` : ''}
                    </div>
                `;
            });

            grid.innerHTML = html || '<div style="color: var(--text-muted); padding: 20px;">No records yet</div>';
        }

        function getRecordIcon(iconName) {
            const icons = {
                'footprints': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 10 3.8 10 5.5c0 3.11-2 5.66-2 8.68V16a2 2 0 1 1-4 0zm16 0v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.63 2 14 3.8 14 5.5c0 3.11 2 5.66 2 8.68V16a2 2 0 1 0 4 0z"/></svg>',
                'flame': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>',
                'heart': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>',
                'moon': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',
                'zap': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>'
            };
            return icons[iconName] || icons['heart'];
        }

        function renderMilestones() {
            const grid = document.getElementById('milestonesGrid');
            if (!grid || typeof AnalyticsEngine === 'undefined') return;

            // Calculate totals from historical data
            const totalSteps = historicalData.reduce((sum, d) => sum + (d.steps || 0), 0);
            const totalWorkouts = historicalData.filter(d => d.workout).length;
            const currentStreak = data.metrics?.currentStreak || 1;

            const milestones = AnalyticsEngine.calculateMilestones(totalSteps, totalWorkouts, currentStreak);

            let html = '';

            // Steps Milestone
            html += renderMilestoneCard('steps', 'Total Steps', milestones.steps, 'steps');

            // Workouts Milestone
            html += renderMilestoneCard('workouts', 'Total Workouts', milestones.workouts, 'workouts');

            // Streak Milestone
            html += renderMilestoneCard('streak', 'Current Streak', milestones.streak, 'days');

            grid.innerHTML = html;
        }

        function renderMilestoneCard(type, title, milestone, unit) {
            const achieved = milestone.achieved || [];
            const next = milestone.next;
            const progress = milestone.progress || 0;
            const current = milestone.current || 0;
            const remaining = milestone.remaining || 0;

            let badgesHtml = '';

            // Show last 2 achieved
            achieved.slice(-2).forEach(m => {
                badgesHtml += `<span class="milestone-badge earned">${AnalyticsEngine.formatMilestone(m)}</span>`;
            });

            // Show next milestone
            if (next) {
                badgesHtml += `<span class="milestone-badge next">${AnalyticsEngine.formatMilestone(next)}</span>`;
            }

            const icons = {
                'steps': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 10 3.8 10 5.5c0 3.11-2 5.66-2 8.68V16a2 2 0 1 1-4 0z"/></svg>',
                'workouts': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
                'streak': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>'
            };

            return `
                <div class="milestone-card">
                    <div class="milestone-header">
                        <div class="milestone-icon ${type}">${icons[type]}</div>
                        <div class="milestone-title">${title}</div>
                    </div>
                    <div class="milestone-achieved">${badgesHtml}</div>
                    <div class="milestone-progress">
                        <div class="milestone-progress-bar">
                            <div class="milestone-progress-fill" style="width: ${Math.min(100, progress)}%"></div>
                        </div>
                        <div class="milestone-progress-text">
                            <span class="milestone-current">${current.toLocaleString()} ${unit}</span>
                            ${next ? ` - ${remaining.toLocaleString()} to next` : ' - Maxed out!'}
                        </div>
                    </div>
                </div>
            `;
        }

        function exportHealthData() {
            if (typeof AnalyticsEngine === 'undefined' || historicalData.length === 0) {
                alert('No data to export');
                return;
            }

            const today = getLocalDateString();
            AnalyticsEngine.exportToCSV(historicalData, `health_data_${today}.csv`);
        }

        // Load data on page load
        // ===== AI Insights =====

        async function initAIInsights() {
            if (typeof InsightsEngine === 'undefined') {
                console.warn('InsightsEngine not loaded');
                return;
            }

            // Load daily insight
            loadDailyInsight();

            // Load prediction
            loadPrediction();

            // Render correlations (with smart patterns)
            renderSmartCorrelations();

            // Set up ask AI input handler
            const askInput = document.getElementById('askAiInput');
            if (askInput) {
                askInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        askAI();
                    }
                });
            }
        }

        async function loadDailyInsight(forceRefresh = false) {
            const textEl = document.getElementById('insightText');
            const actionTextEl = document.getElementById('insightActionText');
            const datapointEl = document.getElementById('insightDatapoint');

            try {
                console.log('Loading daily insight, forceRefresh:', forceRefresh);
                const insight = await InsightsEngine.generateDailyInsight(forceRefresh);
                console.log('Received insight:', insight);

                if (insight) {
                    textEl.textContent = insight.insight || 'No insight available';
                    actionTextEl.textContent = insight.action || 'Keep tracking your health data';
                    datapointEl.textContent = insight.dataPoint
                        ? `Key data: ${insight.dataPoint}`
                        : 'Based on your health data';

                    // Update icon based on category
                    updateInsightIcon(insight.category);
                }
            } catch (error) {
                console.error('Failed to load daily insight:', error);
                textEl.textContent = 'Unable to generate insight at this time.';
                actionTextEl.textContent = 'Check your API configuration';
            }
        }

        function updateInsightIcon(category) {
            const iconEl = document.querySelector('#dailyInsightCard .insight-icon');
            if (!iconEl) return;

            const icons = {
                sleep: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',
                activity: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
                recovery: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
                nutrition: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>',
                consistency: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>'
            };

            iconEl.innerHTML = icons[category] || icons.activity;
        }

        async function refreshDailyInsight() {
            const btn = document.getElementById('refreshInsightBtn');
            btn.classList.add('loading');
            btn.disabled = true;

            try {
                await loadDailyInsight(true); // Force refresh, don't use cache
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        async function loadPrediction() {
            const scoreEl = document.getElementById('predictionScore');
            const confidenceEl = document.getElementById('confidenceText');
            const confidenceDotEl = document.getElementById('confidenceDot');
            const recEl = document.getElementById('predictionRecommendation');
            const tipEl = document.getElementById('predictionTip');
            const warningEl = document.getElementById('predictionWarning');
            const warningTextEl = document.getElementById('predictionWarningText');

            try {
                const prediction = await InsightsEngine.generatePrediction();

                if (prediction) {
                    scoreEl.textContent = prediction.predictedReadiness || '--';

                    const confidence = prediction.confidence || 'medium';
                    confidenceEl.textContent = confidence.charAt(0).toUpperCase() + confidence.slice(1) + ' confidence';
                    confidenceDotEl.className = 'confidence-dot ' + confidence;

                    if (recEl) {
                        recEl.innerHTML = `<strong>Recommendation:</strong> <span>${prediction.recommendation || 'Moderate activity'}</span>`;
                    }
                    if (tipEl) {
                        tipEl.innerHTML = `<strong>Tip:</strong> <span>${prediction.tip || 'Stay consistent'}</span>`;
                    }

                    if (prediction.warning) {
                        warningEl.style.display = 'flex';
                        warningTextEl.textContent = prediction.warning;
                    } else {
                        warningEl.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Failed to load prediction:', error);
                scoreEl.textContent = '--';
                confidenceEl.textContent = 'Unable to predict';
            }
        }

        function renderCorrelations() {
            const grid = document.getElementById('correlationsGrid');
            if (!grid) return;

            const allData = InsightsEngine.collectAllData();
            const correlations = InsightsEngine.findCorrelations(allData);

            if (correlations.length === 0) {
                grid.innerHTML = '<div style="color: var(--text-muted); padding: 16px;">No significant correlations found yet. Keep tracking for more insights.</div>';
                return;
            }

            grid.innerHTML = correlations.slice(0, 4).map(corr => {
                const iconClass = corr.priority === 'high' ? 'warning' :
                                  corr.interpretation?.includes('better') || corr.interpretation?.includes('higher') || corr.interpretation?.includes('above') || corr.interpretation?.includes('excellent') ? 'positive' : 'negative';

                const icon = getCorrelationIcon(corr.type);

                return `
                    <div class="correlation-card">
                        <div class="correlation-header">
                            <div class="correlation-icon ${iconClass}">
                                ${icon}
                            </div>
                            <div class="correlation-title">${corr.factor1} vs ${corr.factor2}</div>
                        </div>
                        <div class="correlation-text">${corr.interpretation}</div>
                        ${corr.recommendation ? `<div class="correlation-recommendation">${corr.recommendation}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function getCorrelationIcon(type) {
            const icons = {
                hrv_baseline: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
                sleep_readiness: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',
                deep_sleep: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',
                stress_recovery: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
                activity_low: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
                hydration_low: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>'
            };
            return icons[type] || '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>';
        }

        function setAskQuestion(question) {
            document.getElementById('askAiInput').value = question;
            askAI();
        }

        async function askAI() {
            const input = document.getElementById('askAiInput');
            const responseEl = document.getElementById('askAiResponse');
            const responseTextEl = document.getElementById('askAiResponseText');
            const btn = document.getElementById('askAiBtn');

            const question = input.value.trim();
            if (!question) return;

            // Clear input field immediately
            input.value = '';

            // Show loading state
            responseEl.classList.add('visible');
            responseTextEl.innerHTML = `
                <div class="ask-ai-response-loading">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6"/>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </svg>
                    Analyzing your data...
                </div>
            `;
            btn.disabled = true;

            try {
                const response = await InsightsEngine.askQuestion(question);

                if (response.text) {
                    responseTextEl.textContent = response.text;
                } else if (response.isError) {
                    responseTextEl.textContent = 'Unable to analyze your data. Please ensure the API is configured correctly.';
                } else {
                    responseTextEl.textContent = JSON.stringify(response, null, 2);
                }
            } catch (error) {
                console.error('Failed to ask AI:', error);
                responseTextEl.textContent = 'Sorry, something went wrong. Please try again.';
            } finally {
                btn.disabled = false;
            }
        }

        // ==================== SMART FEATURES ====================

        /**
         * Render Recovery Protocol card if triggers are met
         */
        function renderRecoveryProtocol(data) {
            const container = document.getElementById('recoveryProtocol');
            const card = document.getElementById('recoveryProtocolCard');
            if (!container || !card) return;

            const goals = typeof GoalsManager !== 'undefined' ? GoalsManager.load().goals : {};
            const protocol = RecommendationEngine.generateRecoveryProtocol(data, goals);

            if (!protocol || !protocol.active) {
                container.style.display = 'none';
                return;
            }

            // Show the card
            container.style.display = 'block';
            card.className = `recovery-protocol-card ${protocol.severity}`;

            // Update title and subtitle
            document.getElementById('recoveryProtocolTitle').textContent = protocol.title;
            document.getElementById('recoveryProtocolSubtitle').textContent = protocol.subtitle;

            // Render trigger badges
            const triggersEl = document.getElementById('recoveryProtocolTriggers');
            triggersEl.innerHTML = protocol.triggers.map(trigger => `
                <span class="recovery-trigger-badge ${trigger.severity}">
                    ${trigger.label}: ${trigger.value}
                </span>
            `).join('');

            // Render recommendations
            const recsEl = document.getElementById('recoveryRecommendations');
            const recIcons = {
                heart: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
                wind: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg>',
                moon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',
                coffee: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/></svg>',
                thermometer: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg>',
                'x-circle': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
                clock: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
                sun: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>'
            };

            recsEl.innerHTML = protocol.recommendations.map(rec => `
                <div class="recovery-recommendation">
                    <div class="recovery-recommendation-icon">
                        ${recIcons[rec.icon] || recIcons.heart}
                    </div>
                    <div class="recovery-recommendation-text">${rec.text}</div>
                </div>
            `).join('');
        }

        /**
         * Render Bedtime Reminder card
         */
        function renderBedtimeCard(data) {
            const card = document.getElementById('bedtimeCard');
            if (!card) return;

            const bedtime = RecommendationEngine.calculateOptimalBedtime(data);

            if (!bedtime) {
                card.style.display = 'none';
                return;
            }

            card.style.display = 'block';

            document.getElementById('bedtimeTime').textContent = bedtime.bedtime;
            document.getElementById('bedtimeTargetSleep').textContent = bedtime.targetSleep;
            document.getElementById('bedtimeWakeTime').textContent = bedtime.wakeTime;
            document.getElementById('bedtimeLatency').textContent = bedtime.avgLatency + ' min';
            document.getElementById('winddownTime').textContent = bedtime.windDown;
            document.getElementById('bedtimeBasedOn').textContent = `Based on ${bedtime.basedOnNights} best nights`;

            // Set the wake time input
            document.getElementById('wakeTimeInput').value = bedtime.wakeTimeRaw;
        }

        /**
         * Update wake time from input
         */
        function updateWakeTime() {
            const input = document.getElementById('wakeTimeInput');
            if (input && input.value) {
                RecommendationEngine.saveTargetWakeTime(input.value);
                // Re-render with new wake time
                if (window.dashboardData) {
                    renderBedtimeCard(window.dashboardData);
                }
            }
        }

        /**
         * Render Goal Suggestions
         */
        function renderGoalSuggestions(data) {
            const container = document.getElementById('goalSuggestions');
            const listEl = document.getElementById('goalSuggestionsList');
            if (!container || !listEl) return;

            const suggestions = GoalsManager.generateSuggestions ? GoalsManager.generateSuggestions(data) : [];

            if (suggestions.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            listEl.innerHTML = suggestions.slice(0, 3).map((sug, idx) => `
                <div class="goal-suggestion-item" data-suggestion-id="${idx}">
                    <div class="goal-suggestion-text">${sug.text}</div>
                    <div class="goal-suggestion-actions">
                        <button class="goal-suggestion-btn apply" onclick="applyGoalSuggestion(${idx})">Apply</button>
                        <button class="goal-suggestion-btn later" onclick="dismissGoalSuggestion(${idx})">Later</button>
                    </div>
                </div>
            `).join('');

            // Store suggestions for later use
            window.currentGoalSuggestions = suggestions;
        }

        /**
         * Apply a goal suggestion
         */
        function applyGoalSuggestion(index) {
            const suggestions = window.currentGoalSuggestions || [];
            const suggestion = suggestions[index];
            if (!suggestion) return;

            if (suggestion.action === 'update') {
                GoalsManager.updateGoal(suggestion.metric, { target: suggestion.newTarget });
            } else if (suggestion.action === 'enable') {
                GoalsManager.updateGoal(suggestion.metric, { enabled: true });
            }

            // Remove the item from UI
            const item = document.querySelector(`[data-suggestion-id="${index}"]`);
            if (item) item.remove();

            // Hide container if no more suggestions
            const remaining = document.querySelectorAll('.goal-suggestion-item');
            if (remaining.length === 0) {
                document.getElementById('goalSuggestions').style.display = 'none';
            }

            // Refresh goals display
            if (window.dashboardData) {
                renderGoals(window.dashboardData);
            }
        }

        /**
         * Dismiss a goal suggestion
         */
        function dismissGoalSuggestion(index) {
            const item = document.querySelector(`[data-suggestion-id="${index}"]`);
            if (item) item.remove();

            const remaining = document.querySelectorAll('.goal-suggestion-item');
            if (remaining.length === 0) {
                document.getElementById('goalSuggestions').style.display = 'none';
            }
        }

        /**
         * Render Smart Correlations (enhances existing correlations with patterns)
         */
        function renderSmartCorrelations() {
            const grid = document.getElementById('correlationsGrid');
            if (!grid) return;

            const allData = InsightsEngine.collectAllData();

            // Get daily correlations
            const dailyCorrelations = InsightsEngine.findCorrelations(allData);

            // Get smart (pattern) correlations
            const smartCorrelations = InsightsEngine.findSmartCorrelations ? InsightsEngine.findSmartCorrelations(allData) : [];

            // Combine, prioritizing patterns
            const allCorrelations = [
                ...smartCorrelations.map(c => ({ ...c, isPattern: true })),
                ...dailyCorrelations.map(c => ({ ...c, isPattern: false }))
            ];

            if (allCorrelations.length === 0) {
                grid.innerHTML = '<div style="color: var(--text-muted); padding: 16px;">No significant correlations found yet. Keep tracking for more insights.</div>';
                return;
            }

            grid.innerHTML = allCorrelations.slice(0, 4).map(corr => {
                const iconClass = corr.priority === 'high' ? 'warning' :
                                  corr.interpretation?.includes('better') || corr.interpretation?.includes('higher') ||
                                  corr.interpretation?.includes('above') || corr.interpretation?.includes('excellent') ||
                                  corr.interpretation?.includes('improved') ? 'positive' : 'negative';

                const icon = getCorrelationIcon(corr.type);
                const badge = corr.isPattern
                    ? '<span class="correlation-badge pattern">Pattern</span>'
                    : '<span class="correlation-badge daily">Daily</span>';

                const confidence = corr.dataPoints
                    ? `<div class="correlation-confidence">Based on ${corr.dataPoints} days of data</div>`
                    : '';

                return `
                    <div class="correlation-card">
                        <div class="correlation-header">
                            <div class="correlation-icon ${iconClass}">
                                ${icon}
                            </div>
                            <div class="correlation-title">${corr.factor1} vs ${corr.factor2}${badge}</div>
                        </div>
                        <div class="correlation-text">${corr.interpretation}</div>
                        ${corr.recommendation ? `<div class="correlation-recommendation">${corr.recommendation}</div>` : ''}
                        ${confidence}
                    </div>
                `;
            }).join('');
        }

        // Initialize: Load API key first, then data
        loadApiKey().then(() => {
            loadData();
            applyPersonalization();
        });
    </script>
</body>
</html>
